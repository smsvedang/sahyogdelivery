<!DOCTYPE html>
<html lang="en">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
    const firebaseConfig = {
  apiKey: "AIzaSyDRcvcvaYSsw19ZmcOikz-FBReqJTtI03s",
  authDomain: "sahyogdelivery.firebaseapp.com",
  projectId: "sahyogdelivery",
  storageBucket: "sahyogdelivery.firebasestorage.app",
  messagingSenderId: "1049559335650",
  appId: "1:1049559335650:web:2cb13685ce3c01b93e94bb",
  measurementId: "G-6BSBHNQHYM"
};
    </script>
<script>
firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
      console.log('‚úÖ Service Worker registered:', reg.scope);
    } catch (err) {
      console.error('‚ùå Service Worker registration failed:', err);
    }
  });
}
</script>
<script>
function askForNotificationPermission() {
  Notification.requestPermission().then(permission => {
    if (permission === "granted") {
      console.log("Notification allowed ‚úÖ");
      getPushToken();
    } else {
      console.log("Notification denied ‚ùå");
    }
  });
}
</script>
<script>
function getPushToken() {
  messaging.getToken({
    vapidKey: "BIaBWwpMVcg8M1uGRb-f_fpoHXLTXWrSMVgJnpfcE3ggEUvksFvPOIRCb_EZRiU4UjIc2xCFSW7rAf1-gQ29kSs"
  }).then(token => {
    if (token) {
      console.log("Push Token:", token);
      saveTokenToServer(token);
    } else {
      console.log("No token received");
    }
  }).catch(err => {
    console.error("Token error:", err);
  });
}
</script>
<script>
function saveTokenToServer(token) {
  fetch(`${API_BASE}/api/save-fcm-token`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${localStorage.getItem("authToken")}`
    },
    body: JSON.stringify({ token })
  })
  .then(res => res.json())
  .then(data => console.log("‚úÖ Token saved:", data))
  .catch(err => console.error("‚ùå Token save failed:", err));
}
</script>

<head>
    <meta name="google-site-verification" content="sUd2hKr4JhoLKMQku6aNRgVeSmyvtjQcuT6ZB4aagRQ" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahyog - Admin Dashboard</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="apple-touch-icon" href="/favicon.png">

    <meta name="theme-color" content="#f1c27d">
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* General Styles */
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        h1, h2 { color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 20px;}
        .header button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button { cursor: pointer; border-radius: 5px; padding: 10px 15px; border: none; margin: 2px; }
        button.btn-primary { background-color: #007bff; color: white; }
        button.btn-secondary { background-color: #6c757d; color: white; }
        button.btn-danger { background-color: #dc3545; color: white; }
        button.btn-warning { background-color: #ffc107; color: black; }
        button.btn-success { background-color: #28a745; color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input, select { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #e9ecef; }
        td button.btn-sm { padding: 5px 8px; font-size: 0.85em; margin-right: 3px;}
        .footer { text-align: center; margin-top: 30px; color: #888; font-size: 0.9em; }

        /* Tabs */
        .tab-bar { border-bottom: 2px solid #dee2e6; margin-bottom: 20px; }
        .tab-bar button { background: #e9ecef; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0; margin-bottom: -2px; border: 1px solid #dee2e6; border-bottom: none; }
        .tab-bar button.active { background: #ffffff; border-bottom: 2px solid #ffffff; font-weight: bold; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 25px; flex: 1; min-width: 400px; border: 1px solid #dee2e6; }

        /* Results & Label */
        #result { padding: 15px; border-radius: 5px; margin-bottom: 20px; word-break: break-all; font-size: 0.95em; }
        #result.success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        #result.error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
        #label { border: 2px dashed #6c757d; padding: 20px; display: none; margin-top: 20px; background: white; }
        #label-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 15px; }
        #qrcode-tracking { width: 128px; height: 128px; margin: 10px auto; }
        #qrcode-tracking img { display: block; margin: auto; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 30px; border: 1px solid #888; border-radius: 8px; width: 80%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .modal-content h2 { margin-top: 0; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        .close-button:hover { color: black; }

        /* User Status Indicator */
        .status-active { color: #198754; font-weight: bold; }
        .status-inactive { color: #dc3545; font-weight: bold; }

        /* Print Specific Styles */
        @media print {
            body * { visibility: hidden; }
            #label, #label * { visibility: visible; }
            #label { position: static; left: 0; top: 0; width: 100mm; min-height: 140mm; height: auto; border: 2px dashed #6c757d !important; box-shadow: none; margin: 10px; padding: 10px; background: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            #label p { margin: 3px 0; font-size: 10pt;}
            #label h3 { font-size: 12pt; margin: 5px 0;}
            #label span { font-size: 10pt; }
            #qrcode-tracking img { width: 100px !important; height: 100px !important; }
             button, .header, .tab-bar, .tab-content:not(#tab-book), #booking-form, #result, #action-buttons, .footer, #manage-users-area, #all-deliveries-table { display: none !important; }
             #tab-book, .container, #result-area, #label { display: block !important; }
              html, body { width: 100mm; height: 140mm; margin: 0; padding: 0; }
        }

        /* Checkbox Size */
        #all-deliveries-table input[type="checkbox"] { transform: scale(1.5); margin: 0 5px 0 3px; cursor: pointer; }
        #select-all-checkbox { transform: scale(1.5); cursor: pointer; }

        /* Users Accordion (Foldable) */
        #user-controls { margin-bottom: 12px; display:flex; gap:10px; align-items:center; }
        .role-section { margin-bottom: 12px; border: 1px solid #e9ecef; border-radius: 6px; background: #fff; overflow: hidden; }
        .role-header { padding: 12px 14px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
        .role-title { font-weight:700; font-size:1.02em; }
        .role-count { color:#666; margin-left: 8px; font-weight:600; }
        .role-body { padding: 8px 14px 14px 14px; border-top:1px solid #f6f6f6; }
        .user-card { display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #f0f0f0; }
        .user-left { display:flex; flex-direction:column; gap:2px; }
        .user-meta { color:#666; font-size:0.9em; margin-left:10px; }
        .user-actions button { margin-left:8px; }
        .badge { display:inline-block; padding:4px 8px; border-radius:12px; font-size:0.8em; margin-left:8px; }
        .badge-role { background:#e9ecef; color:#333; }
        .badge.no-token { background:#ffe6e6; color:#a00; border:1px solid #f5c2c2; padding:3px 7px; font-weight:700; }
        .no-users { color:#666; padding:8px 14px; }

        /* Mobile Friendly Styles */
        /* =========================
   üì± MOBILE RESPONSIVE FIX
========================= */
@media (max-width: 768px) {

  body {
    padding: 8px;
  }

  .header {
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }

  .header h1 {
    font-size: 18px;
  }

  .tab-bar {
    overflow-x: auto;
    white-space: nowrap;
  }

  .tab-bar button {
    font-size: 14px;
    padding: 8px 10px;
  }

  .container {
    flex-direction: column;
  }

  .card {
    min-width: 100% !important;
    padding: 15px;
  }

  table {
    font-size: 13px;
  }

  table thead {
    display: none;
  }

  table tr {
    display: block;
    border: 1px solid #ddd;
    margin-bottom: 10px;
    border-radius: 6px;
    padding: 8px;
  }

  table td {
    display: flex;
    justify-content: space-between;
    border: none;
    padding: 6px 4px;
  }

  table td::before {
    content: attr(data-label);
    font-weight: bold;
    color: #555;
  }

  button {
    width: 100%;
    margin-top: 5px;
  }
}
    </style>
</head>
<body>

    <div class="header">
        <h1>Sahyog Medical Admin (Welcome, <span id="admin-name"></span>)</h1>
        <button id="logout-btn" class="btn-danger">Logout</button>
        <button onclick="askForNotificationPermission()">
  Enable Notifications üîî
</button>
    </div>

    <div class="tab-bar">
        <button class="tab-link active" onclick="openTab(event, 'tab-book')">Book Courier</button>
        <button class="tab-link" onclick="openTab(event, 'tab-drafts')">Draft Orders</button>
        <button class="tab-link" onclick="openTab(event, 'tab-deliveries')">All Deliveries</button>
        <button class="tab-link" onclick="openTab(event, 'tab-manage')">Manage Users</button>
        <button class="tab-link" onclick="openTab(event, 'tab-settings')">Business Settings</button>
    </div>

    <div id="tab-book" class="tab-content active">
        <div class="container">
            <div class="card" id="booking-area">
                <h2>Book New Courier</h2>
                <form id="booking-form">
                    <label for="name">Customer Name:</label>
                    <input type="text" id="name" required>
                    <label for="address">Customer Address:</label>
                    <input type="text" id="address" required>
                    <label for="phone">Customer Phone:</label>
                    <input type="text" id="phone" required>
                    <label for="paymentMethod">Payment Mode:</label>
                    <select id="paymentMethod" onchange="toggleBillAmount(this.value)">
                        <option value="Prepaid">Prepaid</option>
                        <option value="COD">COD (Cash on Delivery)</option>
                    </select>
                    <div id="billAmountDiv" style="display:none;">
                        <label for="billAmount">Bill Amount (‚Çπ):</label>
                        <input type="number" id="billAmount" value="0" min="0">
                    </div>
                    <label for="assignedTo">Assign To Manager:</label>
                    <select id="assignedTo">
                        <option value="">Assign to Manager...</option>
                    </select>
                    <button type="submit" id="submit-btn" class="btn-primary">Book Courier</button>
                </form>
            </div>
            <div class="card" id="result-area">
                <h2>Booking Status</h2>
                <div id="result"><p>Please fill booking details...</p></div>
                <div id="action-buttons" style="display:none; margin-bottom: 15px;">
                    <button id="print-btn" class="btn-secondary">üñ®Ô∏è Print Label</button>
                    <button id="share-btn" class="btn-secondary">‚úâÔ∏è Share with Customer</button>
                    <button id="whatsapp-btn" class="btn-success">üì≤ Send on WhatsApp</button>
                    <button id="copy-btn" class="btn-warning">üìã Copy Details</button>
                </div>
                <div id="label"></div>
            </div>
        </div>
    </div>

    <div id="tab-drafts" class="tab-content">
  <div class="card" style="min-width:95%;">
    <h2>Draft Orders (Margmart)</h2>
    <button class="btn-primary" onclick="fetchMargmartOrders()">
  üì© Fetch Margmart Orders
</button>
<button class="btn-secondary" onclick="loadDrafts()">
  üîÑ Refresh
</button>

    <table>
      <thead>
        <tr>
          <th>Order No</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Amount</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="drafts-body"></tbody>
    </table>
  </div>
</div>

    <div id="tab-deliveries" class="tab-content">
        <div class="card" style="min-width: 95%; overflow-x: auto;">
            <h2>All Bookings</h2>
            <button id="refresh-deliveries-btn" class="btn-secondary">Refresh List</button>
            <button id="sync-google-sheet-btn" class="btn-success" style="margin-left: 10px;">
    Sync with Google Sheet
</button>
<span style="margin-left: 20px;">With Selected:</span>
            <div id="bulk-actions" style="margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <strong>With Selected:</strong>
                <button id="bulk-reprint-btn" class="btn-secondary btn-sm">Reprint Labels</button>
                <button id="bulk-cancel-btn" class="btn-warning btn-sm">Cancel Deliveries</button>
                <button id="bulk-delete-btn" class="btn-danger btn-sm">Delete Records</button>
                <span id="selection-count" style="margin-left: 10px; font-style: italic;">(0 selected)</span>
            </div>
            <table id="all-deliveries-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-checkbox" title="Select All"></th>
                        <th>Tracking ID</th>
                        <th>Customer</th>
                        <th>Status</th>
                        <th>Payment</th>
                        <th>COD Status</th>
                        <th>Assigned Manager</th>
                        <th>Assigned Boy</th>
                        <th>OTP</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="all-deliveries-body"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-manage" class="tab-content">
        <div class="card" style="min-width: 95%; overflow-x: auto;">
            <h2>Manage Users</h2>
            <button id="add-user-btn" class="btn-primary" style="margin-bottom: 15px;">+ Create User</button>

<div id="add-user-container" style="display:none; margin-bottom:20px;">
    <div style="padding:20px; background:white; border-radius:8px; border:1px solid #ddd;">
        <h3>Create New User</h3>
        <form id="add-user-form">
            <label>Name:</label>
            <input type="text" id="add-user-name" required>

            <label>Email (Username):</label>
            <input type="email" id="add-user-email" required>

            <label>Phone:</label>
            <input type="text" id="add-user-phone">

            <label>Password:</label>
            <input type="text" id="add-user-password" required>

            <label>Role:</label>
            <select id="add-user-role" required>
                <option value="delivery">Delivery Boy</option>
                <option value="manager">Manager</option>
                <option value="admin">Admin</option>
            </select>
          <div id="manager-select-box">
    <label>Assign to Manager (required for Delivery Boys):</label>
    <select id="assign-manager"></select>
</div>

            <button type="submit" class="btn-success" style="margin-top:15px;">Create User</button>
        </form>
        <div id="add-user-result" class="message"></div>
    </div>
</div>

<div id="user-controls">
    <input type="search" id="user-search" placeholder="Search name, email or phone" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;">
    <label style="display:flex;align-items:center;gap:8px;font-weight:600;color:#555;"><input type="checkbox" id="show-inactive"> Show inactive</label>
    <button id="collapse-all-btn" class="btn-secondary">Collapse All</button>
    <button id="expand-all-btn" class="btn-secondary">Expand All</button>
</div>

<div id="users-accordion"></div>
<p id="users-empty" class="no-users" style="display:none;">No users found.</p> 
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="card" style="min-width: 95%;">
            <h2>Business Settings</h2>
            <form id="business-settings-form">
                <h3>Business Information</h3>
                <label for="business-name">Business Name:</label>
                <input type="text" id="business-name" required>
                <label for="business-address">Business Address:</label>
                <input type="text" id="business-address" required>
                <label for="business-phone">Business Phone:</label>
                <input type="text" id="business-phone" required>
                <h3>Logo Management</h3>
                <label for="business-logo-url">Logo Image URL:</label>
                <input type="text" id="business-logo-url" placeholder="e.g., https://example.com/logo.png">
                <p>Current Logo Preview:</p>
                <img id="logo-preview" src="" alt="Business Logo" style="max-width: 150px; max-height: 75px; border: 1px solid #ddd; padding: 5px; margin-bottom: 15px; background: white; display: none;">
                <h3>Payment Management (UPI)</h3>
                <label for="upi-id">UPI ID (e.g., yourname@bank):</label>
                <input type="text" id="upi-id" placeholder="Enter UPI ID for payments">
                <label for="upi-name">UPI Beneficiary Name:</label>
                <input type="text" id="upi-name" placeholder="Name associated with UPI ID">
                <button type="submit" class="btn-primary" style="margin-top: 20px;">Save Settings</button>
            </form>
            <div id="settings-result" class="message" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div id="user-edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('user-edit-modal')">&times;</span>
            <h2>Edit User</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <label for="edit-user-name">Name:</label>
                <input type="text" id="edit-user-name" required>
                <label for="edit-user-email">Email (Username):</label>
                <input type="email" id="edit-user-email" required>
                <label for="edit-user-phone">Phone:</label>
                <input type="text" id="edit-user-phone">
                <label for="edit-user-role">Role:</label>
                <select id="edit-user-role" required>
                    <option value="admin">Admin</option>
                    <option value="manager">Manager</option>
                    <option value="delivery">Delivery</option>
                </select>
                <div id="edit-manager-select-box">
                    <label>Assign to Manager (required for Delivery Boys):</label>
                    <select id="edit-assign-manager"></select>
                </div>
                <hr style="margin: 20px 0;">
                <label for="edit-user-password">New Password (leave blank to keep current):</label>
                <input type="text" id="edit-user-password" placeholder="Enter new password only if changing">
                <button type="submit" class="btn-primary" style="margin-top: 15px;">Save Changes</button>
            </form>
             <div id="edit-user-result" class="message" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div class="footer">
        Copyright ¬© <span id="copyright-year"></span> Sahyog Medical Delivery Platform. All Rights Reserved.
    </div>

 <script>
    const API_BASE = 'https://sahyogdeliverybackend.onrender.com';
    // --- 1. Global Variables & Constants ---
    const token = localStorage.getItem('authToken');
    const role = localStorage.getItem('userRole');
    const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
    let allDeliveriesData = []; // Store delivery data for reprint/bulk actions
    let allUsersData = []; // Store user data for editing
    let businessSettings = {}; // Holds loaded business settings

    document.getElementById("add-user-role").onchange = function(){
  const box = document.getElementById("manager-select-box");

  if(this.value === "delivery"){
    box.style.display = "block";
    loadManagersForDropdown(); // üî• MAIN FIX
  }else{
    box.style.display = "none";
  }
};

    // --- 2. Tab Logic (Must be defined globally for onclick) ---
    function openTab(event, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { if(tabcontent[i]) tabcontent[i].style.display = "none"; }
        tablinks = document.getElementsByClassName("tab-link");
        for (i = 0; i < tablinks.length; i++) { if(tablinks[i]) tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        const currentTab = document.getElementById(tabName);
        if (currentTab) currentTab.style.display = "block";
        if (event && event.currentTarget) event.currentTarget.className += " active";
        
        // Refresh data when tabs are opened
        if (tabName === 'tab-deliveries') loadAllDeliveries();
        if (tabName === 'tab-manage') loadAllUsers();
        if (tabName === 'tab-settings') loadBusinessSettings();
    }

    // --- 3. Modal Helpers ---
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'flex';
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'none';
    }
    // Close modal if clicked outside content area
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            closeModal(event.target.id);
        }
    }

    // --- 4. Helper Functions ---
    function toggleBillAmount(value) {
        const div = document.getElementById('billAmountDiv');
        if(div) div.style.display = (value === 'COD') ? 'block' : 'none';
    }

    // --- 5. Label Generation & Print ---
    // (UPDATED - Amazon-style design + BillAmount fix)
    function generateSingleLabelHtml(name, address, trackingId, paymentMethod, phone, qrPlaceholderId, billAmount) {
        // Business settings se data ya default fallback
        const fromName = businessSettings.businessName || 'Sahyog Medical Store';
        const fromAddress = businessSettings.businessAddress || 'Near Majeji Nursing Home, 458110, Dist-Neemuch, Madhya Pradesh';
        const fromPhone = businessSettings.businessPhone || '+91 7415543744';
        const logoHtml = businessSettings.logoUrl
            ? `<img src="${businessSettings.logoUrl}" alt="Logo" style="max-height: 40px; max-width: 120px; margin-bottom: 5px;">`
            : `<strong style="font-size: 14pt;">${fromName}</strong>`;

        // Payment method ko saaf karna (FIXED: Ab argument se value lega)
        const paymentText = (paymentMethod === 'COD') ? `COD: ‚Çπ${billAmount || 0}` : 'Prepaid';

        return `
<div class="label-container"
style="
width: 100mm;
min-height: 140mm;
border: 2.5px solid #000;
position: relative;
overflow: hidden;
font-family: Arial, sans-serif;
box-sizing: border-box;

/* üî• STRIPES */
background:
  /* üîπ DIAGONAL STRIPES */
  repeating-linear-gradient(
    45deg,
    rgba(0,0,0,0.05) 0px,
    rgba(0,0,0,0.05) 12px,
    transparent 12px,
    transparent 24px
  ),

  /* üîπ SAHYOG MEDICAL TEXT WATERMARK */
  repeating-linear-gradient(
    45deg,
    transparent 0px,
    transparent 60px,     /* ‚¨ÖÔ∏è text line gap ‚âà 1.5cm */
    rgba(0,0,0,0.18) 60px,
    rgba(0,0,0,0.18) 62px,
    transparent 62px,
    transparent 120px
  ),

  #ffffff;

-webkit-print-color-adjust: exact;
print-color-adjust: exact;
">

    <style scoped>
        .label-container *, .label-container *::before, .label-container *::after { box-sizing: border-box; }
        .label-section { display: flex; border-bottom: 2.5px solid black; position: relative; z-index: 1;}
        .label-section:last-child { border-bottom: none; flex-grow: 1; }
        .label-box { padding: 10px; word-wrap: break-word; }
        .label-box p { margin: 0 0 5px 0; padding: 0; font-size: 10pt; line-height: 1.4; }
        .label-box strong { font-size: 11pt; }
        .label-box .header { font-size: 10pt; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        
        .label-from { flex-basis: 50%; border-right: 2.5px solid black; }
        .label-ship-to { flex-basis: 50%; }
        .label-ship-to p.cust-name { font-size: 14pt; font-weight: bold; margin-bottom: 5px; }
        .label-ship-to p.cust-phone { font-size: 12pt; font-weight: bold; margin-top: 5px; }

        .label-qr-code { flex-basis: 45%; border-right: 2.5px solid black; display: flex; align-items: center; justify-content: center; padding: 10px; }
        .label-qr-code .qr-code-img { margin: 0 auto; }
        .label-qr-code .qr-code-img img { width: 90px !important; height: 90px !important; }

        .label-details { flex-basis: 55%; padding: 10px; display: flex; flex-direction: column; justify-content: center; }
        .label-details .detail-block { margin-bottom: 10px; }
        .label-details .detail-block span { font-size: 10pt; display: block; text-transform: uppercase; }
        .label-details .detail-block strong { font-size: 15pt; display: block; letter-spacing: 0.5px; }
        
        .label-tracking-text { padding: 10px; text-align: center; font-weight: bold; font-size: 11pt; letter-spacing: 2px; }
    </style>

    <div class="label-section">
        <div class="label-box label-from">
            <p class="header">FROM:</p>
            ${logoHtml}
            <p>${fromName}<br>${fromAddress}<br>Ph: ${fromPhone}</p>
        </div>
        <div class="label-box label-ship-to">
            <p class="header">SHIP TO:</p>
            <p class="cust-name">${name || 'N/A'}</p>
            <p>${address || 'N/A'}</p>
            <p class="cust-phone">Ph: ${phone || 'N/A'}</p>
        </div>
    </div>

    <div class="label-section">
        <div class="label-box label-qr-code">
            <div id="${qrPlaceholderId}" class="qr-code-img"></div>
        </div>
        <div class="label-box label-details">
            <div class="detail-block">
                <span>Tracking ID</span>
                <strong>${trackingId || 'N/A'}</strong>
            </div>
            <div class="detail-block">
                <span>Payment</span>
                <strong>${paymentText}</strong>
            </div>
        </div>
    </div>

    <div class="label-section">
        <div class="label-box label-tracking-text">
            TRACK:-${(trackingId || 'N/A').replace('-', '')}
        </div>
    </div>

    <br><br>
    <div class="label-section">
    <div class="label-box"
        style="
            width: 100%;
            text-align: center;
            font-size: 8.5pt;
            color: #333;
        ">
        <!-- Instructions (UPPER) -->
        <div style="margin-bottom: 6px; font-weight: 600;">
            Please verify the parcel before accepting.<br>
            Do not share OTP until delivery is completed.
        </div>

        <!-- Thank You (LOWER, LIGHT) -->
        <div style="font-size: 8pt; color: #666;">
            Thank you for choosing Sahyog Medical<br>
            For more details, visit: www.sahyogmedical.in
        </div>
    </div>
</div>

</div>
        `;
    }

    // Generates label preview in the #label div (UPDATED with billAmount)
    function generateLabelPreview(name, address, trackingId, paymentMethod, phone, billAmount) {
        const labelDiv = document.getElementById('label');
        if (!labelDiv) { console.error("#label preview div not found!"); return false; }
        const qrPlaceholderId = 'qrcode-tracking-preview';
        
        // Pass billAmount to HTML generator
        labelDiv.innerHTML = generateSingleLabelHtml(name, address, trackingId, paymentMethod, phone, qrPlaceholderId, billAmount);
        
        labelDiv.style.display = 'block';
        const qrElement = labelDiv.querySelector(`#${qrPlaceholderId}`);
        if (qrElement && trackingId) {
            qrElement.innerHTML = '';
            try { new QRCode(qrElement, { text: trackingId, width: 90, height: 90, correctLevel: QRCode.CorrectLevel.H }); return true; }
            catch (qrError) { console.error("QR Error:", qrError); qrElement.innerHTML = '<p style="color:red; font-size: small;">QR Error</p>'; }
        } else { console.error("QR Placeholder/TrackingID missing for preview."); }
        return false;
    }

    // Sets up Print and Share button actions (UPDATED with billAmount)
    function setupActionButtons(trackingId, otp, phone, billAmount) {
    const shareBtn = document.getElementById('share-btn');
    const whatsappBtn = document.getElementById('whatsapp-btn');
    const copyBtn = document.getElementById('copy-btn');
    const printBtn = document.getElementById('print-btn');

    const message =
`*Sahyog Medical Courier Booked*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Tracking ID: ${trackingId}
OTP: ${otp}
Payment: ${paymentMethod === 'COD' ? 'COD ‚Çπ' + billAmount : 'Prepaid'}
Track here:
${window.location.origin}/track.html?tid=${trackingId}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

    /* SHARE (default system share) */
    if (shareBtn) {
        shareBtn.onclick = async () => {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Courier Details',
                        text: message
                    });
                } catch (e) {
                    alert("Share cancelled");
                }
            } else {
                alert("Share not supported here. Use WhatsApp or Copy.");
            }
        };
    }

    /* ‚úÖ SEND ON WHATSAPP */
    if (whatsappBtn) {
        whatsappBtn.onclick = () => {
            const cleanPhone = phone.replace(/\D/g, '');
            const url = `https://wa.me/91${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        };
    }

    /* üìã COPY DETAILS */
    if (copyBtn) {
        copyBtn.onclick = async () => {
            try {
                await navigator.clipboard.writeText(message);
                alert("Details copied to clipboard ‚úÖ");
            } catch (e) {
                alert("Copy failed ‚ùå");
            }
        };
    }

    /* PRINT */
    if (printBtn) {
        printBtn.onclick = () => {
            const deliveryData = allDeliveriesData.find(d => d.trackingId === trackingId);
            if (deliveryData) {
                printSingleLabel(
                    deliveryData.customerName,
                    deliveryData.customerAddress,
                    deliveryData.trackingId,
                    deliveryData.paymentMethod,
                    deliveryData.customerPhone,
                    deliveryData.billAmount
                );
            }
        };
    }
}

    // Function specifically for printing a single label (UPDATED with billAmount)
    function printSingleLabel(name, address, trackingId, paymentMethod, phone, billAmount) {
        const qrPlaceholderId = `print-qr-${trackingId}-${Date.now()}`;
        
        // Pass billAmount to HTML generator
        const labelHtml = generateSingleLabelHtml(name, address, trackingId, paymentMethod, phone, qrPlaceholderId, billAmount);
        
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        if (!printWindow) { alert("Please allow popups to print."); return; }
        printWindow.document.write(`<html><head><title>Print Label - ${trackingId}</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script><style>body{margin:0;padding:0}@page{size: 100mm 140mm;;margin:5mm }.label-container{margin:0 !important;page-break-inside:avoid}@media print{-webkit-print-color-adjust:exact;print-color-adjust:exact}</style></head><body>${labelHtml}<script>try{const el=document.getElementById('${qrPlaceholderId}');if(el&&'${trackingId}'){new QRCode(el,{text:'${trackingId}',width:90,height:90,correctLevel:QRCode.CorrectLevel.H})}else{console.error("QR Element/ID missing")}}catch(e){console.error("QR Error:",e);const el=document.getElementById('${qrPlaceholderId}');if(el)el.innerHTML='QR Error'}setTimeout(()=>{window.print()},500);<\/script></body></html>`);
        printWindow.document.close();
    }

    // --- 6. Business Settings Logic ---
    async function loadBusinessSettings() { // Loads when tab is opened
        const resDiv=document.getElementById('settings-result'),logoPre=document.getElementById('logo-preview'); if(!resDiv||!logoPre)return;
        resDiv.textContent='Loading...';resDiv.className='message';
        try{const r=await fetch(`${API_BASE}/admin/settings`, { headers });if(r.status===401){window.location.href='/login';return}if(!r.ok)throw new Error(`HTTP ${r.status}`); const s=await r.json(); businessSettings=s;
        const nameEl=document.getElementById('business-name'),addrEl=document.getElementById('business-address'),phoneEl=document.getElementById('business-phone'),logoUrlEl=document.getElementById('business-logo-url'),upiIdEl=document.getElementById('upi-id'),upiNameEl=document.getElementById('upi-name');
        if(nameEl)nameEl.value=s.businessName||''; if(addrEl)addrEl.value=s.businessAddress||''; if(phoneEl)phoneEl.value=s.businessPhone||''; if(logoUrlEl)logoUrlEl.value=s.logoUrl||''; if(upiIdEl)upiIdEl.value=s.upiId||''; if(upiNameEl)upiNameEl.value=s.upiName||'';
        if(s.logoUrl){logoPre.src=s.logoUrl;logoPre.style.display='block'}else{logoPre.style.display='none'} resDiv.textContent='';
        }catch(e){console.error("Load settings error:",e);resDiv.textContent=`Error: ${e.message}`;resDiv.className='message error'}
    }
    async function loadBusinessSettingsOnLoad() {
    try {
        const response = await fetch(`${API_BASE}/admin/settings`, { headers });

        if (response.status === 401) {
            window.location.href = 'login.html';
            return;
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        businessSettings = await response.json();
        console.log("Initial settings loaded:", businessSettings);

    } catch (err) {
        console.error("Initial settings load error:", err);
    }
}
    async function handleBusinessSettingsSubmit(e) {
        e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'),resDiv=document.getElementById('settings-result'),logoPre=document.getElementById('logo-preview'); if(!btn||!resDiv||!logoPre)return;
        btn.disabled=true;btn.textContent='Saving...';resDiv.textContent='';resDiv.className='message';
        const data={businessName:e.target.elements['business-name'].value,businessAddress:e.target.elements['business-address'].value,businessPhone:e.target.elements['business-phone'].value,logoUrl:e.target.elements['business-logo-url'].value,upiId:e.target.elements['upi-id'].value,upiName:e.target.elements['upi-name'].value};
        try{const r=await fetch(`${API_BASE}/admin/settings`,{method:'PUT',headers,body:JSON.stringify(data)}); const d=await r.json();
        if(r.ok){resDiv.textContent=d.message||'Saved!';resDiv.className='message success';businessSettings=d.settings||data; if(businessSettings.logoUrl){logoPre.src=businessSettings.logoUrl;logoPre.style.display='block'}else{logoPre.style.display='none'}}
        else{resDiv.textContent=`Error: ${d.message||'Save failed.'}`;resDiv.className='message error'}
        }catch(e){console.error("Save settings error:",e);resDiv.textContent=`Server error: ${e.message}`;resDiv.className='message error'}
        finally{btn.disabled=false;btn.textContent='Save Settings';setTimeout(()=>{if(resDiv)resDiv.textContent=''},3000)}
    }

    // --- 7. Load All Deliveries (Definition) ---
    // (FIXED - Checkbox added)
    async function loadAllDeliveries() {
        const tbody = document.getElementById('all-deliveries-body');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        if (selectAllCheckbox) selectAllCheckbox.checked = false;
        updateSelectionCount();
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="11">Loading deliveries...</td></tr>';
        try {
            const response = await fetch(`${API_BASE}/admin/deliveries`, { headers });
            if (response.status === 401) { window.location.href = 'login.html'; return; }
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            const deliveries = await response.json();
            allDeliveriesData = deliveries;
            tbody.innerHTML = '';
            if(deliveries.length === 0) { tbody.innerHTML = '<tr><td colspan="11" style="text-align: center;">No deliveries found.</td></tr>'; return; }
            
            deliveries.forEach(d => {
                const row = tbody.insertRow(); row.style.verticalAlign = 'middle';
                
                // --- CHECKBOX FIX ---
                const cellCheckbox = row.insertCell(0); 
                const checkbox = document.createElement('input'); 
                checkbox.type = 'checkbox'; 
                checkbox.className = 'delivery-checkbox'; 
                checkbox.value = d._id; 
                cellCheckbox.appendChild(checkbox); // <-- This line fixes it
                cellCheckbox.style.width = '30px';
                // --- END FIX ---
                
                row.insertCell(1).textContent = d.trackingId || 'N/A';
                row.insertCell(2).textContent = d.customerName || 'N/A';
                const cellStatus = row.insertCell(3); cellStatus.innerHTML = `<strong>${d.currentStatus || 'N/A'}</strong>`;
                row.insertCell(4).textContent = d.paymentMethod === 'COD' ? `‚Çπ${d.billAmount}` : 'Prepaid';
                let codStatusText = 'N/A'; if (d.paymentMethod === 'COD') { codStatusText = d.codPaymentStatus || 'Pending'; } row.insertCell(5).textContent = codStatusText;
                row.insertCell(6).textContent = d.assignedByManager && d.assignedByManager.name ? d.assignedByManager.name : 'N/A';
                row.insertCell(7).textContent = d.assignedTo && d.assignedTo.name ? d.assignedTo.name : (d.assignedBoyDetails && d.assignedBoyDetails.name ? d.assignedBoyDetails.name + ' (Assigned)' : 'N/A');
                const cellOtp = row.insertCell(8); cellOtp.innerHTML = `<strong>${d.otp || 'N/A'}</strong>`;
                const date = new Date(d.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric'}); row.insertCell(9).textContent = date;
                const cellActions = row.insertCell(10); const isCancelable = !['Delivered', 'Cancelled'].includes(d.currentStatus);
                cellActions.innerHTML = `<button class="btn-secondary btn-sm" onclick="reprintLabel('${d._id}')" title="Reprint Label">Reprint</button><button class="btn-warning btn-sm" onclick="cancelDelivery('${d._id}')" ${!isCancelable ? 'disabled title="Cannot cancel"' : 'title="Cancel Delivery"'}>Cancel</button><button class="btn-danger btn-sm" onclick="deleteDelivery('${d._id}')" title="Delete Record">Delete</button>`;
            });
        } catch (err) { console.error("Error loading deliveries:", err); tbody.innerHTML = `<tr><td colspan="11" style="color: red; text-align: center;">Error: ${err.message}</td></tr>`; }
    }

    // --- 8. Booking Form Submit Handler (Definition) ---
    // (UPDATED with billAmount pass)
    async function handleBookingSubmit(e) {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-btn'); const resultDiv = document.getElementById('result'); const labelDiv = document.getElementById('label'); const actionButtonsDiv = document.getElementById('action-buttons');
        if(!submitBtn || !resultDiv || !labelDiv || !actionButtonsDiv) return;
        submitBtn.disabled = true; submitBtn.textContent = "Booking..."; resultDiv.innerHTML = '<p>Processing...</p>'; resultDiv.className = 'message'; labelDiv.style.display = 'none'; labelDiv.innerHTML = ''; actionButtonsDiv.style.display = 'none';
        
        const formData = { 
            name: document.getElementById('name').value, 
            address: document.getElementById('address').value, 
            phone: document.getElementById('phone').value, 
            paymentMethod: document.getElementById('paymentMethod').value, 
            billAmount: document.getElementById('billAmount').value || 0, // Store value
            managerId: document.getElementById('assignedTo').value || null 
        }; 
        console.log("Submitting:", formData);
        
        try { 
            const response = await fetch(`${API_BASE}/book`, { method: 'POST', headers, body: JSON.stringify(formData) });
            let data; 
            try { const txt = await response.text(); data = JSON.parse(txt); } 
            catch (e) { data = { message: `Err ${response.status}. Invalid JSON.` }; }
            
            if (response.ok) { 
                resultDiv.className = 'success'; 
                resultDiv.innerHTML = `<strong>${data.message||'Success!'}</strong><br>ID: ${data.trackingId} | OTP: ${data.otp}`;
                
                // Call Preview function (FIX: Pass formData.billAmount)
                const labelGenerated = generateLabelPreview(formData.name, formData.address, data.trackingId, formData.paymentMethod, formData.phone, formData.billAmount);
                
                if (labelGenerated) { 
                    actionButtonsDiv.style.display = 'block'; 
                    // (FIX: Pass formData.billAmount)
                    setupActionButtons(data.trackingId, data.otp, formData.phone, formData.billAmount); 
                } else { 
                    resultDiv.innerHTML += '<br><span style="color:orange;">Warn: Label failed.</span>'; 
                }
                
                loadAllDeliveries(); 
                e.target.reset(); // Reset form AFTER using the values
                toggleBillAmount('Prepaid');
            } else { 
                resultDiv.className = 'error'; 
                resultDiv.innerHTML = `<strong>Failed:</strong> ${data.message || `Error ${response.status}`}`; 
            }
        } catch (error) { 
            resultDiv.className = 'error'; 
            resultDiv.innerHTML = `<strong>Error:</strong> ${error.message || 'Connection failed.'}`; 
        }
        finally { submitBtn.disabled = false; submitBtn.textContent = "Book Courier"; }
    }

    // --- 9. Manage Users Logic (Definitions) ---
    
    // (FIXED - Function Added)
    async function loadManagersForDropdown() {
        const dropdown = document.getElementById('assignedTo');
        if (!dropdown) {
            console.warn("Manager dropdown (#assignedTo) not found.");
            return;
        }
        try {
            const response = await fetch(`${API_BASE}/admin/managers`, { headers });
            if (response.status === 401) { window.location.href = 'login.html'; return; }
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            
            const managers = await response.json();
            const currentValue = dropdown.value;
            dropdown.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = ""; 
            defaultOption.textContent = "-- Assign Later (None) --";
            dropdown.appendChild(defaultOption);

            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager._id;
                option.textContent = manager.name;
                dropdown.appendChild(option);
            });
            dropdown.value = currentValue || "";

        } catch (err) {
            console.error("Failed to load managers for dropdown:", err);
            dropdown.innerHTML = '<option value="">Error loading managers</option>';
        }
    }

    async function loadAllUsers() {
        const accordion = document.getElementById('users-accordion'); if(!accordion) return; accordion.innerHTML = '<div class="no-users">Loading users...</div>';
        try {
            const r = await fetch(`${API_BASE}/admin/users`, { headers });
            if (r.status === 401) { window.location.href = '/login'; return }
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const users = await r.json(); allUsersData = users || [];
            renderUsers();
            loadManagersForDropdown(); // refresh manager list used by forms
        } catch (e) {
            console.error("Load users error:", e);
            accordion.innerHTML = `<div class="no-users" style="color:red;">Error loading users: ${e.message}</div>`;
        }
    }

    function renderUsers() {
        const q = (document.getElementById('user-search')?.value || '').trim().toLowerCase();
        const showInactive = !!document.getElementById('show-inactive')?.checked;
        const accordion = document.getElementById('users-accordion'); if(!accordion) return;
        accordion.innerHTML = '';

        const filtered = allUsersData.filter(u => {
            if (!showInactive && !u.isActive) return false;
            if (!q) return true;
            const hay = `${u.name || ''} ${u.email || ''} ${u.phone || ''}`.toLowerCase();
            return hay.includes(q);
        });

        if (filtered.length === 0) {
            document.getElementById('users-empty').style.display = 'block';
            return;
        } else {
            document.getElementById('users-empty').style.display = 'none';
        }

        const byRole = filtered.reduce((acc, u) => { acc[u.role] = acc[u.role] || []; acc[u.role].push(u); return acc; }, {});

        const rolesOrder = ['admin','manager','delivery'];
        rolesOrder.forEach(roleKey => {
            const list = byRole[roleKey] || [];
            const roleTitle = roleKey.charAt(0).toUpperCase() + roleKey.slice(1) + (roleKey==='delivery'?' Boys':'s');
            const section = document.createElement('div'); section.className = 'role-section';
            const header = document.createElement('div'); header.className = 'role-header';
            header.innerHTML = `<div><span class="role-title">${roleTitle}</span><span class="role-count">${list.length}</span></div><div><button class="btn-secondary" data-role-toggle>Toggle</button></div>`;
            header.querySelector('[data-role-toggle]').addEventListener('click', (e)=>{ e.stopPropagation(); body.style.display = (body.style.display === 'none') ? '' : 'none'; e.target.textContent = body.style.display === 'none' ? 'Expand' : 'Collapse'; });
            header.addEventListener('click', ()=>{ body.style.display = (body.style.display === 'none') ? '' : 'none'; const btn = header.querySelector('[data-role-toggle]'); if(btn) btn.textContent = body.style.display === 'none' ? 'Expand' : 'Collapse'; });
            section.appendChild(header);
            const body = document.createElement('div'); body.className = 'role-body';

            if (list.length === 0) {
                body.innerHTML = `<div class="no-users">No ${roleTitle} found.</div>`;
            } else {
                if (roleKey === 'delivery') {
                    // Group delivery boys by their manager
                    const byManager = list.reduce((acc, u) => {
                        const mname = (u.createdByManager && u.createdByManager.name) ? u.createdByManager.name : 'Unassigned';
                        acc[mname] = acc[mname] || [];
                        acc[mname].push(u);
                        return acc;
                    }, {});

                    Object.keys(byManager).forEach(managerName => {
                        const groupHeader = document.createElement('div'); groupHeader.style.padding = '8px 0 4px 0'; groupHeader.style.fontWeight = '700'; groupHeader.style.borderBottom = '1px solid #f0f0f0';
                        groupHeader.style.display = 'flex'; groupHeader.style.justifyContent = 'space-between'; groupHeader.style.alignItems = 'center';
                        groupHeader.innerHTML = `<div>${managerName} <span class="role-count">(${byManager[managerName].length})</span></div><div><button class="btn-secondary" data-mgr-toggle>Expand</button></div>`;
                        const mgrBody = document.createElement('div'); mgrBody.style.padding = '6px 0 12px 10px'; mgrBody.style.display = 'none';
                        byManager[managerName].forEach(u => {
                            const card = document.createElement('div'); card.className = 'user-card';
                            const tokenBadge = (!u.fcmTokens || (Array.isArray(u.fcmTokens) && u.fcmTokens.length === 0)) ? '<span class="badge no-token">No Token</span>' : '';
                            const left = document.createElement('div'); left.className = 'user-left'; left.innerHTML = `<strong>${u.name} ${tokenBadge}</strong><div class="user-meta">${u.email}${u.phone?(' ‚Ä¢ '+u.phone):''}</div>`;
                            const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
                            const statusSpan = document.createElement('span'); statusSpan.className = u.isActive? 'status-active' : 'status-inactive'; statusSpan.textContent = u.isActive? 'Active' : 'Inactive';
                            const editBtn = document.createElement('button'); editBtn.className = 'btn-secondary'; editBtn.textContent = 'Edit'; editBtn.onclick = ()=>openEditUserModal(u._id);
                            const toggleBtn = document.createElement('button'); toggleBtn.className = u.isActive? 'btn-warning':'btn-success'; toggleBtn.textContent = u.isActive? 'Deactivate':'Activate'; toggleBtn.onclick = ()=>{ if(confirm(`Are you sure to ${u.isActive? 'deactivate':'activate'} ${u.name}?`)) toggleUserActive(u._id); };
                            right.appendChild(statusSpan); right.appendChild(editBtn); right.appendChild(toggleBtn);
                            card.appendChild(left); card.appendChild(right);
                            mgrBody.appendChild(card);
                        });
                        // attach toggle behavior
                        const toggleBtn = groupHeader.querySelector('[data-mgr-toggle]');
                        toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); if (mgrBody.style.display === 'none') { mgrBody.style.display = ''; toggleBtn.textContent = 'Collapse'; } else { mgrBody.style.display = 'none'; toggleBtn.textContent = 'Expand'; } });
                        groupHeader.addEventListener('click', () => { if (mgrBody.style.display === 'none') { mgrBody.style.display = ''; if (toggleBtn) toggleBtn.textContent = 'Collapse'; } else { mgrBody.style.display = 'none'; if (toggleBtn) toggleBtn.textContent = 'Expand'; } });
                        body.appendChild(groupHeader);
                        body.appendChild(mgrBody);
                    });
                } else {
                    list.forEach(u => {
                        const card = document.createElement('div'); card.className = 'user-card';
                        const tokenBadge = (!u.fcmTokens || (Array.isArray(u.fcmTokens) && u.fcmTokens.length === 0)) ? '<span class="badge no-token">No Token</span>' : '';
                        const left = document.createElement('div'); left.className = 'user-left'; left.innerHTML = `<strong>${u.name} ${tokenBadge}</strong><div class="user-meta">${u.email}${u.phone?(' ‚Ä¢ '+u.phone):''}</div>`;
                        const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center';
                        const statusSpan = document.createElement('span'); statusSpan.className = u.isActive? 'status-active' : 'status-inactive'; statusSpan.textContent = u.isActive? 'Active' : 'Inactive';
                        const editBtn = document.createElement('button'); editBtn.className = 'btn-secondary'; editBtn.textContent = 'Edit'; editBtn.onclick = ()=>openEditUserModal(u._id);
                        const toggleBtn = document.createElement('button'); toggleBtn.className = u.isActive? 'btn-warning':'btn-success'; toggleBtn.textContent = u.isActive? 'Deactivate':'Activate'; toggleBtn.onclick = ()=>{ if(confirm(`Are you sure to ${u.isActive? 'deactivate':'activate'} ${u.name}?`)) toggleUserActive(u._id); };
                        right.appendChild(statusSpan); right.appendChild(editBtn); right.appendChild(toggleBtn);
                        card.appendChild(left); card.appendChild(right);
                        body.appendChild(card);
                    });
                }
            }

            section.appendChild(body);
            accordion.appendChild(section);
        });
    }

    // Collapse / Expand All handlers
    function collapseAllRoles() { document.querySelectorAll('.role-body').forEach(b=>{ b.style.display = 'none'; const btn=b.previousSibling.querySelector('[data-role-toggle]'); if(btn) btn.textContent = 'Expand'; }); }
    function expandAllRoles() { document.querySelectorAll('.role-body').forEach(b=>{ b.style.display = ''; const btn=b.previousSibling.querySelector('[data-role-toggle]'); if(btn) btn.textContent = 'Collapse'; }); }

    // Wire up controls
    document.addEventListener('DOMContentLoaded', () => {
        const search = document.getElementById('user-search'); if(search) search.addEventListener('input', ()=>renderUsers());
        const showInactive = document.getElementById('show-inactive'); if(showInactive) showInactive.addEventListener('change', ()=>renderUsers());
        const collapseBtn = document.getElementById('collapse-all-btn'); if(collapseBtn) collapseBtn.addEventListener('click', collapseAllRoles);
        const expandBtn = document.getElementById('expand-all-btn'); if(expandBtn) expandBtn.addEventListener('click', expandAllRoles);
    });
    
    async function handleAddUserSubmit(e) {
    e.preventDefault();

    const resDiv = document.getElementById('add-user-result');
    if (!resDiv) return;

    resDiv.textContent = 'Creating user...';
    resDiv.className = 'message';

    // Get role first
    const role = document.getElementById('add-user-role').value;

    // Prepare payload
    const formData = {
        name: document.getElementById('add-user-name').value,
        email: document.getElementById('add-user-email').value,
        phone: document.getElementById('add-user-phone').value,
        password: document.getElementById('add-user-password').value,
        role: role,
        managerId: role === "delivery"
            ? document.getElementById('assign-manager').value
            : null
    };

    // Validation: manager required for delivery boy
    if (role === "delivery" && !formData.managerId) {
        resDiv.textContent = "Please select a manager for Delivery Boy.";
        resDiv.className = "message error";
        return;
    }

    try {
        const r = await fetch(`${API_BASE}/admin/create-user`, {
            method: 'POST',
            headers,
            body: JSON.stringify(formData)
        });

        const d = await r.json();

        if (r.ok) {
            resDiv.textContent = d.message || "User created successfully";
            resDiv.className = "message success";

            // Reset form
            document.getElementById('add-user-form').reset();
            document.getElementById('manager-select-box').style.display = "none";

            // Refresh users list
            loadAllUsers();

            // If new manager added, refresh manager dropdown
            if (role === "manager") {
                loadManagersForDropdown();
            }

            // Close modal / container after short delay
            setTimeout(() => {
                const modal = document.getElementById('add-user-modal');
                if (modal) modal.style.display = "none";
            }, 1200);

        } else {
            resDiv.textContent = d.message || "Failed to create user";
            resDiv.className = "message error";
        }

    } catch (err) {
        console.error("Add user error:", err);
        resDiv.textContent = "Server error while creating user.";
        resDiv.className = "message error";
    }
}
    
    function openEditUserModal(userId) {
        const user = allUsersData.find(u=>u._id===userId); if(!user)return; const idEl=document.getElementById('edit-user-id'),nameEl=document.getElementById('edit-user-name'),emailEl=document.getElementById('edit-user-email'),phoneEl=document.getElementById('edit-user-phone'),roleEl=document.getElementById('edit-user-role'),passEl=document.getElementById('edit-user-password'),resEl=document.getElementById('edit-user-result'),managerEl=document.getElementById('edit-assign-manager');
        if(idEl)idEl.value=user._id; if(nameEl)nameEl.value=user.name; if(emailEl)emailEl.value=user.email; if(phoneEl)phoneEl.value=user.phone||''; if(roleEl)roleEl.value=user.role; if(passEl)passEl.value=''; if(resEl)resEl.textContent=''; if(managerEl)managerEl.value=user.createdByManager?user.createdByManager._id:''; openModal('user-edit-modal');
    }
    
    async function handleEditUserSubmit(e) {
        e.preventDefault(); const userId=document.getElementById('edit-user-id').value,resDiv=document.getElementById('edit-user-result'); if(!userId||!resDiv)return; resDiv.textContent='Saving...';resDiv.className='message'; const uData={name:e.target.elements['edit-user-name'].value,email:e.target.elements['edit-user-email'].value,phone:e.target.elements['edit-user-phone'].value,role:e.target.elements['edit-user-role'].value,managerId:e.target.elements['edit-assign-manager'].value || null}; const newPass=e.target.elements['edit-user-password'].value;
        
        // Validation: manager required for delivery boy
        if (uData.role === "delivery" && !uData.managerId) {
            resDiv.textContent = "Please select a manager for Delivery Boy.";
            resDiv.className = "message error";
            return;
        }
        try{const rDet=await fetch(`${API_BASE}/admin/user/${userId}`,{method:'PUT',headers,body:JSON.stringify(uData)}); if(!rDet.ok){const d=await rDet.json();throw new Error(d.message||'Update failed')} if(newPass&&newPass.trim()!==''){const rPass=await fetch(`${API_BASE}/admin/user/${userId}/password`,{method:'PATCH',headers,body:JSON.stringify({password:newPass})}); if(!rPass.ok){const d=await rPass.json();throw new Error(d.message||'Pass update failed')}} resDiv.textContent='Updated!';resDiv.className='message success'; loadAllUsers();loadManagersForDropdown(); setTimeout(()=>closeModal('user-edit-modal'),1500);
        }catch(e){console.error("Edit user error:",e);resDiv.textContent=`Error: ${e.message}`;resDiv.className='message error'}
    }
    
    async function toggleUserActive(userId) {
        try{const r=await fetch(`${API_BASE}/admin/user/${userId}/toggle-active`,{method:'PATCH',headers}); if(!r.ok){const d=await r.json();throw new Error(d.message||'Toggle failed')} const d=await r.json();console.log(d.message);loadAllUsers();loadManagersForDropdown();}
        catch(e){console.error("Toggle active error:",e);alert(`Error: ${e.message}`)}
    }

    // --- 10. Delivery Actions (Definitions) ---
    // (UPDATED with billAmount)
    function reprintLabel(deliveryId) {
        const delivery = allDeliveriesData.find(d => d._id === deliveryId); 
        if (!delivery) { alert('Delivery data not found.'); return; }
        // Call printSingleLabel for reprint, opens new window
        printSingleLabel(delivery.customerName, delivery.customerAddress, delivery.trackingId, delivery.paymentMethod, delivery.customerPhone, delivery.billAmount);
    }
    async function cancelDelivery(deliveryId) {
        if(!confirm('Cancel this delivery?'))return; try{const r=await fetch(`${API_BASE}/admin/delivery/${deliveryId}/cancel`,{method:'PATCH',headers}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Cancel failed'); alert(d.message);loadAllDeliveries();}catch(e){console.error("Cancel err:",e);alert(`Error: ${e.message}`)}
    }
    async function deleteDelivery(deliveryId) {
        if(!confirm('DELETE record permanently?'))return; try{const r=await fetch(`${API_BASE}/admin/delivery/${deliveryId}`,{method:'DELETE',headers}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Delete failed'); alert(d.message);loadAllDeliveries();}catch(e){console.error("Delete err:",e);alert(`Error: ${e.message}`)}
    }

    // --- 11. Bulk Action Helper Functions ---
    function getSelectedDeliveryIds(){const ids=[];document.querySelectorAll('#all-deliveries-body .delivery-checkbox:checked').forEach(cb=>ids.push(cb.value));return ids}
    function updateSelectionCount(){const count=document.querySelectorAll('#all-deliveries-body .delivery-checkbox:checked').length; const countSpan=document.getElementById('selection-count'); const selAll=document.getElementById('select-all-checkbox'); const allCb=document.querySelectorAll('#all-deliveries-body .delivery-checkbox'); if(countSpan)countSpan.textContent=`(${count} selected)`; if(selAll&&allCb.length>0){selAll.checked=(count===allCb.length);selAll.indeterminate=(count>0&&count<allCb.length)}else if(selAll){selAll.checked=false;selAll.indeterminate=false}}
    function handleSelectAll(e){if(!e||!e.target)return; document.querySelectorAll('#all-deliveries-body .delivery-checkbox').forEach(cb=>{cb.checked=e.target.checked});updateSelectionCount()}

    // --- 12. Bulk Action Handlers ---
    // (UPDATED with billAmount)
    function handleBulkReprint(){
        const ids = getSelectedDeliveryIds(); if(ids.length === 0){ alert("Select deliveries."); return; } console.log("Bulk print:", ids);
        let combinedLabelsHtml = ''; let qrCodeTasks = [];
        ids.forEach((id, index) => { 
            const delivery = allDeliveriesData.find(d => d._id === id); 
            if (!delivery) { console.warn(`Data missing: ${id}`); return; } 
            const qrPlaceholderId = `bulk-qr-${id}-${Date.now()}`; 
            const pageBreak = index > 0 ? 'page-break-before: always; margin-top: 5mm;' : 'margin-top: 0;'; 
            combinedLabelsHtml += `<div class="label-print-instance" style="${pageBreak}">`; 
            // Pass billAmount
            combinedLabelsHtml += generateSingleLabelHtml( delivery.customerName, delivery.customerAddress, delivery.trackingId, delivery.paymentMethod, delivery.customerPhone, qrPlaceholderId, delivery.billAmount ); 
            combinedLabelsHtml += `</div>`; 
            qrCodeTasks.push({ id: qrPlaceholderId, text: delivery.trackingId }); 
        });
        const printWindow = window.open('', '_blank', 'width=800,height=600'); if (!printWindow) { alert("Allow popups."); return; }
        printWindow.document.write(`<html><head><title>Print Labels</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script><style>@page{size:100mm 140mm;margin:5mm}html,body{width:100mm;height:140mm;margin:0;padding:0}body{-webkit-print-color-adjust:exact;print-color-adjust:exact}.label-print-instance{width:100mm;min-height:140mm;margin:0!important;padding:0!important;page-break-after:always;page-break-inside:avoid}.label-print-instance:last-child{page-break-after:avoid}</style></head><body>${combinedLabelsHtml}<script>const qrTasks=${JSON.stringify(qrCodeTasks)};qrTasks.forEach(t=>{const el=document.getElementById(t.id);if(el&&t.text){try{new QRCode(el,{text:t.text,width:90,height:90,correctLevel:QRCode.CorrectLevel.H})}catch(e){console.error("QR Error:",e);if(el)el.innerHTML='QR Err'}}});setTimeout(()=>{window.print()},500);<\/script></body></html>`); printWindow.document.close();
        const selectAll = document.getElementById('select-all-checkbox'); if(selectAll)selectAll.checked=false; document.querySelectorAll('.delivery-checkbox:checked').forEach(cb=>cb.checked=false); updateSelectionCount();
    }
    async function handleBulkCancel(){
        const ids=getSelectedDeliveryIds(); if(ids.length===0){alert("Select deliveries.");return} if(!confirm(`Cancel ${ids.length} deliveries?`))return; console.log("Cancelling:", ids);
        try{const r=await fetch(`${API_BASE}/admin/deliveries/bulk-cancel`,{method:'POST',headers,body:JSON.stringify({deliveryIds:ids})}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Bulk cancel failed'); alert(`Cancelled ${d.cancelledCount||0}.`); loadAllDeliveries(); const sa=document.getElementById('select-all-checkbox');if(sa)sa.checked=false;updateSelectionCount();}catch(e){console.error("Bulk cancel:",e);alert(`Error: ${e.message}`)}
    }
    async function handleBulkDelete(){
        const ids=getSelectedDeliveryIds(); if(ids.length===0){alert("Select deliveries.");return} if(!confirm(`DELETE ${ids.length} records permanently?`))return; console.log("Deleting:", ids);
        try{const r=await fetch(`${API_BASE}/admin/deliveries/bulk-delete`,{method:'POST',headers,body:JSON.stringify({deliveryIds:ids})}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Bulk delete failed'); alert(`Deleted ${d.deletedCount||0}.`); loadAllDeliveries(); const sa=document.getElementById('select-all-checkbox');if(sa)sa.checked=false;updateSelectionCount();}catch(e){console.error("Bulk delete:",e);alert(`Error: ${e.message}`)}
    }
    
    // --- (NEW) 13. Google Sheet Sync Handler ---
    async function handleGoogleSheetSync() {
        const syncBtn = document.getElementById('sync-google-sheet-btn');
        if (!syncBtn) return;

        if (!confirm('This will replace all data in the Google Sheet with the current database. Continue?')) {
            return;
        }

        const originalText = syncBtn.textContent;
        syncBtn.disabled = true;
        syncBtn.textContent = 'Syncing...';
        
        let resultSpan = document.getElementById('sync-result-span');
        if (!resultSpan) {
            resultSpan = document.createElement('span');
            resultSpan.id = 'sync-result-span';
            resultSpan.style.marginLeft = '10px';
            syncBtn.after(resultSpan);
        }
        resultSpan.textContent = '';

        try {
            const response = await fetch(`${API_BASE}/admin/sync-to-google-sheet`, {
                method: 'POST',
                headers
            });

            const data = await response.json();

            if (response.ok) {
                resultSpan.textContent = data.message || 'Sync Success!';
                resultSpan.style.color = 'green';
                console.log('Sync successful:', data.message);
            } else {
                throw new Error(data.message || 'Sync failed');
            }

        } catch (error) {
            console.error('Error syncing to Google Sheet:', error);
            resultSpan.textContent = `Error: ${error.message}`;
            resultSpan.style.color = 'red';
        } finally {
            syncBtn.disabled = false;
            syncBtn.textContent = originalText;
            setTimeout(() => {
                if (resultSpan) resultSpan.textContent = '';
            }, 5000);
        }
    }


    // --- 14. Security Guard & Initial Load (Main Execution) ---
    document.addEventListener('DOMContentLoaded', () => {
        // Check auth
        if (!token || role !== 'admin') {
            localStorage.clear();
            window.location.href = 'login.html';
            return; // Stop execution if not admin
        }

        // Populate static elements
        const adminNameEl = document.getElementById('admin-name');
        const copyrightYearEl = document.getElementById('copyright-year');
        if(adminNameEl) adminNameEl.textContent = localStorage.getItem('userName');
        if(copyrightYearEl) copyrightYearEl.textContent = new Date().getFullYear();

        // Setup static event listeners
        const refreshBtn = document.getElementById('refresh-deliveries-btn');
        const syncBtn = document.getElementById('sync-google-sheet-btn'); // (NEW)
        const addUserBtn = document.getElementById('add-user-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const bookingFormEl = document.getElementById('booking-form');
        const addUserFormEl = document.getElementById('add-user-form');
        const editUserFormEl = document.getElementById('edit-user-form');
        const businessSettingsForm = document.getElementById('business-settings-form');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const deliveriesTableBody = document.getElementById('all-deliveries-body');
        const bulkReprintBtn = document.getElementById('bulk-reprint-btn');
        const bulkCancelBtn = document.getElementById('bulk-cancel-btn');
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

        if(refreshBtn) refreshBtn.onclick = loadAllDeliveries;
        if(syncBtn) syncBtn.onclick = handleGoogleSheetSync; // (NEW)
        if(addUserBtn) addUserBtn.onclick = () => {
            const resultDiv = document.getElementById('add-user-result');
            const form = document.getElementById('add-user-form');
            if(resultDiv) resultDiv.textContent = '';
            if(form) form.reset();
            openModal('add-user-modal');
        };
        if(logoutBtn) logoutBtn.onclick = () => { localStorage.clear(); window.location.href = '/login.html'; };
        if(bookingFormEl) bookingFormEl.addEventListener('submit', handleBookingSubmit);
        if(addUserFormEl) addUserFormEl.addEventListener('submit', handleAddUserSubmit);
        if(editUserFormEl) editUserFormEl.addEventListener('submit', handleEditUserSubmit);
        if(businessSettingsForm) businessSettingsForm.addEventListener('submit', handleBusinessSettingsSubmit);
        if(selectAllCheckbox) selectAllCheckbox.addEventListener('change', handleSelectAll);
        if(deliveriesTableBody) deliveriesTableBody.addEventListener('change', updateSelectionCount);
        if(bulkReprintBtn) bulkReprintBtn.onclick = handleBulkReprint;
        if(bulkCancelBtn) bulkCancelBtn.onclick = handleBulkCancel;
        if(bulkDeleteBtn) bulkDeleteBtn.onclick = handleBulkDelete;

        // Initial data loads
        loadManagersForDropdown(); // (FIXED)
        loadBusinessSettingsOnLoad(); // Load settings early
        loadAllDeliveries(); // Load deliveries last
    });

//---15. Load Managers in Assign To Dropdown---
async function loadManagersForDropdown(){
    const select = document.getElementById("assign-manager");
    select.innerHTML = `<option value="">Select Manager</option>`;

    const res = await fetch(`${API_BASE}/admin/managers`,{ headers });
    const managers = await res.json();

    managers.forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m._id;
        opt.textContent = m.name;
        select.appendChild(opt);
    });
}

//16. Load Manager for booking form
async function loadManagersForBooking(){
    const select = document.getElementById("assignedTo");
    if(!select) return;

    select.innerHTML = '<option value="">Assign to Manager...</option>';

    try{
        const res = await fetch(`${API_BASE}/admin/managers`, { headers });
        if(!res.ok) throw new Error("Failed to load managers");

        const managers = await res.json();
        managers.forEach(m=>{
            const opt = document.createElement("option");
            opt.value = m._id;
            opt.textContent = m.name;
            select.appendChild(opt);
        });
    }catch(err){
        console.error("Booking manager load error:", err);
    }
}
document.addEventListener("DOMContentLoaded", () => {
    loadManagersForBooking();   // üî• THIS FIXES YOUR ISSUE
});

//---18. Load Managers on Admin Page Load---
async function loadManagersForDropdown() {
    const selects = ['assign-manager', 'edit-assign-manager'];
    
    selects.forEach(id => {
        const select = document.getElementById(id);
        if (!select) return;

        select.innerHTML = '<option value="">Select Manager</option>';
    });

    try {
        const res = await fetch(`${API_BASE}/admin/managers`, { headers });
        if (!res.ok) throw new Error("Failed to load managers");

        const managers = await res.json();

        selects.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            
            managers.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m._id;
                opt.textContent = m.name;
                select.appendChild(opt);
            });
        });

    } catch (err) {
        console.error("Manager dropdown error:", err);
    }
}

// Load managers when admin page loads
document.addEventListener("DOMContentLoaded", () => {
    const addUserForm = document.getElementById("add-user-form");
    if (addUserForm) {
        addUserForm.addEventListener("submit", handleAddUserSubmit);
    }

    // Hide/Show Form
    const addUserBtn = document.getElementById("add-user-btn");
    if (addUserBtn) {
        addUserBtn.onclick = () => {
            let box = document.getElementById("add-user-container");
            box.style.display = box.style.display == "none" ? "block" : "none";
        };
    }

    // Detect Role Change & show Manager Assign box
    // Now always visible
});

//--- 19. Draft Orders Tab Logic ---
async function loadDrafts() {
  const res = await fetch(`${API_BASE}/api/drafts`, {
    headers: { "Authorization": `Bearer ${localStorage.getItem("authToken")}` }
  });
  const drafts = await res.json();
  const tbody = document.getElementById('drafts-body');
  tbody.innerHTML = '';

  drafts.forEach(d => {
    // ‚ùó WhatsApp MESSAGE: wahi existing tracking-ID wala hi use hoga
    // Abhi draft me trackingId nahi hota, isliye WhatsApp button OPTIONAL rakhenge
    // (Best flow: pehle "Create Courier", phir existing whatsapp-btn use karo)

    tbody.innerHTML += `
      <tr>
        <td>${d.orderNumber}</td>
        <td>${d.customerName}</td>
        <td>${d.phone}</td>
        <td>‚Çπ${d.amount}</td>
        <td>
          <button class="btn-primary btn-sm" onclick="createCourierFromDraft('${d._id}')">üöö Create Courier</button>
        </td>
      </tr>
    `;
  });
}
async function createCourierFromDraft(draftId) {
  const managerId = prompt("Manager ID daalein (optional):");
  
  const res = await fetch(`${API_BASE}/admin/convert-draft-to-courier`, {
    method: "POST",
    headers,
    body: JSON.stringify({
      draftId,
      managerId,
      paymentMethod: "Prepaid"
    })
  });

  const data = await res.json();
  alert(data.message || "Done");

  // üîÑ REFRESH DRAFT LIST
  loadDrafts();
}

async function prefillBookingFromDraft(draftId) {
  const res = await fetch(`${API_BASE}/api/drafts`, {
    headers: { "Authorization": `Bearer ${localStorage.getItem("authToken")}` }
  });
  const drafts = await res.json();
  const d = drafts.find(x => x._id === draftId);
  if (!d) return alert('Draft not found');

  // Book Courier tab open karo
  openTab(null, 'tab-book');

  // Existing booking form prefill
  document.getElementById('name').value = d.customerName || '';
  document.getElementById('address').value = d.address || '';
  document.getElementById('phone').value = d.phone || '';
  document.getElementById('paymentMethod').value = d.paymentMethod || 'Prepaid';
  document.getElementById('billAmount').value = d.amount || 0;

  alert('Details prefilled. Ab Book Courier click karo.');
}

async function fetchMargmartOrders() {
  try {
    const res = await fetch(`${API_BASE}/api/fetch-margmart-orders`, {
      method: 'POST',
      headers: {
        "Authorization": `Bearer ${localStorage.getItem("authToken")}`
      }
    });

    const data = await res.json();
    alert(data.message || 'Fetched');
    loadDrafts();
  } catch (err) {
    alert('Failed to fetch emails');
  }
}

// üîÑ Auto refresh Draft Orders every 30 seconds
setInterval(() => {
  console.log("üîÑ Auto refreshing drafts...");
  loadDrafts();
}, 30000);
window.addEventListener("load", () => {
  loadDrafts();
});
</script>