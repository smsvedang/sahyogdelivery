<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahyog - Admin Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        h1, h2 { color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* --- ‡§®‡§Ø‡§æ: ‡§ü‡•à‡§¨ (Tab) ‡§ï‡§æ ‡§∏‡•ç‡§ü‡§æ‡§á‡§≤ --- */
        .tab-bar { border-bottom: 2px solid #ccc; }
        .tab-bar button { background: #eee; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0; }
        .tab-bar button.active { background: #fff; border-bottom: 2px solid #007bff; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        /* ------------------------------ */

        .container { display: flex; flex-wrap: wrap; gap: 20px; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 25px; flex: 1; min-width: 400px; }
        form label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        form input, form select { width: 95%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        form button { background-color: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%; }
        #result { padding: 15px; border-radius: 5px; margin-bottom: 20px; word-break: break-all; }
        #result.success { background-color: #d4edda; color: #155724; }
        #result.error { background-color: #f8d7da; color: #721c24; }
        #label { border: 2px dashed #333; padding: 20px; display: none; margin-top: 20px; }
        #label-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 15px; }
        #qr-container { display: flex; justify-content: space-around; text-align: center; }
        #qrcode-tracking, #qrcode-payment { width: 128px; height: 128px; margin: 10px auto; }
        #action-buttons button { background-color: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        #all-deliveries-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #all-deliveries-table th, #all-deliveries-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #all-deliveries-table th { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <div class="header">
        <h1>‡§∏‡§π‡§Ø‡•ã‡§ó ‡§Æ‡•á‡§°‡§ø‡§ï‡§≤ - ‡§è‡§°‡§Æ‡§ø‡§® ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° (Welcome, <span id="admin-name"></span>)</h1>
        <button id="logout-btn">Logout</button>
    </div>

    <div class="tab-bar">
        <button class="tab-link active" onclick="openTab(event, 'tab-book')">‡§®‡§Ø‡§æ ‡§ï‡•Ç‡§∞‡§ø‡§Ø‡§∞</button>
        <button class="tab-link" onclick="openTab(event, 'tab-deliveries')">‡§∏‡§≠‡•Ä ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä</button>
        <button class="tab-link" onclick="openTab(event, 'tab-manage')">‡§Ø‡•Ç‡•õ‡§∞ ‡§Æ‡•à‡§®‡•á‡§ú ‡§ï‡§∞‡•á‡§Ç</button>
    </div>

    <div id="tab-book" class="tab-content active">
        <div class="container">
            <div class="card" id="booking-area">
                <h2>‡§®‡§Ø‡§æ ‡§ï‡•Ç‡§∞‡§ø‡§Ø‡§∞ ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç</h2>
                <form id="booking-form">
                    <label for="name">‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§ï‡§æ ‡§®‡§æ‡§Æ:</label>
                    <input type="text" id="name" required>
                    <label for="address">‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§ï‡§æ ‡§™‡§§‡§æ:</label>
                    <input type="text" id="address" required>
                    <label for="phone">‡§ï‡§∏‡•ç‡§ü‡§Æ‡§∞ ‡§ï‡§æ ‡•û‡•ã‡§®:</label>
                    <input type="text" id="phone" required>
                    <label for="paymentMethod">‡§™‡•á‡§Æ‡•á‡§Ç‡§ü ‡§Æ‡•ã‡§°:</label>
                    <select id="paymentMethod" onchange="toggleBillAmount(this.value)">
                        <option value="Prepaid">Prepaid</option>
                        <option value="COD">COD (Cash on Delivery)</option>
                    </select>
                    <div id="billAmountDiv" style="display:none;">
                        <label for="billAmount">‡§¨‡§ø‡§≤ ‡§Ö‡§Æ‡§æ‡§â‡§Ç‡§ü (‚Çπ):</label>
                        <input type="number" id="billAmount" value="0" min="0">
                    </div>
                    <label for="assignedTo">‡§ï‡§ø‡§∏‡§ï‡•ã ‡§Ö‡§∏‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç:</label>
                    <select id="assignedTo">
                        <option value="">Select Delivery Boy</option>
                        </select>
                    <button type="submit" id="submit-btn">‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç</button>
                </form>
            </div>
            
            <div class="card" id="result-area">
                <h2>‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏</h2>
                <div id="result"><p>‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§°‡§ø‡§ü‡•á‡§≤‡•ç‡§∏ ‡§≠‡§∞‡•á‡§Ç...</p></div>
                <div id="action-buttons" style="display:none;">
                    <button id="print-btn">üñ®Ô∏è Print Label</button>
                    <button id="share-btn">‚úâÔ∏è Share with Customer</button>
                </div>
                <div id="label">
                    <div id="label-header">
                        <h3>Sahyog Medical</h3>
                        <span id="label-payment-method" style="font-weight:bold;"></span>
                    </div>
                    <p><strong>TO:</strong> <span id="label-name"></span></p>
                    <p><strong>TRACKING ID:</strong> <span id="label-tracking-id"></span></p>
                    <div id="qr-container">
                        <div>
                            <div id="qrcode-tracking"></div>
                            <small>Scan to Track/Update</small>
                        </div>
                        <div id="payment-qr-div" style="display:none;">
                            <div id="qrcode-payment"></div>
                            <small><strong>Scan to Pay (Bill: ‚Çπ<span id="label-bill-amount"></span>)</strong></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-deliveries" class="tab-content">
        <div class="card" style="min-width: 95%;">
            <h2>‡§∏‡§≠‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó‡•ç‡§∏ (OTP ‡§ï‡•á ‡§∏‡§æ‡§•)</h2>
            <button id="refresh-deliveries-btn">Refresh List</button>
            <table id="all-deliveries-table">
                <thead>
                    <tr>
                        <th>Tracking ID</th>
                        <th>Customer</th>
                        <th>Status</th>
                        <th>OTP</th>
                        <th>Payment</th>
                        <th>Assigned To</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="all-deliveries-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="tab-manage" class="tab-content">
        <div class="card" id="manage-boys-area">
            <h2>Manage Delivery Boys</h2>
            <form id="create-boy-form">
                <label for="boy-name">Name:</label>
                <input type="text" id="boy-name" required>
                <label for="boy-email">Email (Username):</label>
                <input type="email" id="boy-email" required>
                <label for="boy-password">Password:</label>
                <input type="text" id="boy-password" required>
                <button type="submit">Create Delivery Boy</button>
            </form>
            <div id="create-boy-result"></div>
            <h3>Existing Delivery Boys:</h3>
            <ul id="delivery-boy-list"></ul>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('authToken');
        const role = localStorage.getItem('userRole'); // ‡§®‡§Ø‡§æ: ‡§∞‡•ã‡§≤ (Role) ‡§ï‡•ã ‡§™‡•ù‡§®‡§æ
        
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        };

        // --- 1. (‡§∏‡§¨‡§∏‡•á ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä) ‡§∏‡§ø‡§ï‡•ç‡§Ø‡•ã‡§∞‡§ø‡§ü‡•Ä ‡§ó‡§æ‡§∞‡•ç‡§° ---
        window.onload = () => {
            // ‡§Ö‡§ó‡§∞ ‡§ü‡•ã‡§ï‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‡§Ø‡§æ ‡§∞‡•ã‡§≤ 'admin' ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§§‡•ã ‡§¨‡§æ‡§π‡§∞ ‡§®‡§ø‡§ï‡§æ‡§≤‡•ã
            if (!token || role !== 'admin') {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                window.location.href = '/login'; // ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡•á‡§ú ‡§™‡§∞ ‡§µ‡§æ‡§™‡§∏ ‡§≠‡•á‡§ú‡•á‡§Ç
                return; // ‡§¨‡§æ‡§ï‡•Ä ‡§ï‡§æ ‡§ï‡•ã‡§° ‡§Æ‡§§ ‡§ö‡§≤‡§æ‡§ì
            }
            
            // ‡§Ö‡§ó‡§∞ ‡§è‡§°‡§Æ‡§ø‡§® ‡§π‡•à, ‡§§‡•ã ‡§π‡•Ä ‡§™‡•á‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡•ã
            document.getElementById('admin-name').textContent = localStorage.getItem('userName');
            loadDeliveryBoys();
            loadAllDeliveries();
        };

        // --- 2. ‡§ü‡•à‡§¨ (Tab) ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ---
        function openTab(event, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            event.currentTarget.className += " active";
            
            // ‡§Ö‡§ó‡§∞ "All Deliveries" ‡§ü‡•à‡§¨ ‡§ñ‡•ã‡§≤‡§æ ‡§π‡•à, ‡§§‡•ã ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
            if (tabName === 'tab-deliveries') {
                loadAllDeliveries();
            }
        }

        // --- 3. ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§¨‡•â‡§Ø ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ---
        async function loadDeliveryBoys() {
            const selectBox = document.getElementById('assignedTo');
            const userList = document.getElementById('delivery-boy-list');
            selectBox.innerHTML = '<option value="">Select Delivery Boy</option>'; // Reset
            userList.innerHTML = 'Loading...';

            try {
                const response = await fetch('/admin/delivery-boys', { headers });
                if (response.status === 401) window.location.href = '/login';
                if (!response.ok) throw new Error('Failed to load users');
                
                const users = await response.json();
                userList.innerHTML = ''; // Clear
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user._id;
                    option.textContent = `${user.name} (${user.email})`;
                    selectBox.appendChild(option);
                    
                    const li = document.createElement('li');
                    li.textContent = `${user.name} (${user.email})`;
                    userList.appendChild(li);
                });
            } catch (err) {
                userList.innerHTML = `Error: ${err.message}`;
            }
        }

        // --- 4. ‡§∏‡§≠‡•Ä ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ---
        document.getElementById('refresh-deliveries-btn').onclick = loadAllDeliveries;
        async function loadAllDeliveries() {
            const tbody = document.getElementById('all-deliveries-body');
            tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';
            
            try {
                const response = await fetch('/admin/deliveries', { headers });
                if (response.status === 401) window.location.href = '/login';
                if (!response.ok) throw new Error('Failed to load deliveries');

                const deliveries = await response.json();
                tbody.innerHTML = ''; // Clear loading
                
                deliveries.forEach(d => {
                    const row = document.createElement('tr');
                    const date = new Date(d.createdAt).toLocaleDateString('en-IN');
                    
                    row.innerHTML = `
                        <td>${d.trackingId}</td>
                        <td>${d.customerName}</td>
                        <td><strong>${d.currentStatus}</strong></td>
                        <td><strong>${d.otp}</strong></td>
                        <td>${d.paymentMethod} (‚Çπ${d.billAmount})</td>
                        <td>${d.assignedTo ? d.assignedTo.name : 'N/A'}</td>
                        <td>${date}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="7">Error: ${err.message}</td></tr>`;
            }
        }

        // --- 5. ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§´‡•â‡§∞‡•ç‡§Æ ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ---
        const bookingForm = document.getElementById('booking-form');
        bookingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = "Booking...";

            const resultDiv = document.getElementById('result');
            const labelDiv = document.getElementById('label');
            const qrTrackingDiv = document.getElementById('qrcode-tracking');
            const qrPaymentDiv = document.getElementById('qrcode-payment');
            const qrPaymentContainer = document.getElementById('payment-qr-div');
            
            labelDiv.style.display = 'none';
            document.getElementById('action-buttons').style.display = 'none';
            qrTrackingDiv.innerHTML = '';
            qrPaymentDiv.innerHTML = '';
            qrPaymentContainer.style.display = 'none';
            resultDiv.innerHTML = '';
            resultDiv.className = '';

            const formData = {
                name: document.getElementById('name').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                billAmount: document.getElementById('billAmount').value,
                assignedTo: document.getElementById('assignedTo').value
            };

            try {
                const response = await fetch('/book', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'success';
                    resultDiv.innerHTML = `<strong>${data.message}</strong><br>Tracking ID: ${data.trackingId} | OTP: ${data.otp}`;
                    
                    document.getElementById('label-name').textContent = formData.name;
                    document.getElementById('label-tracking-id').textContent = data.trackingId;
                    document.getElementById('label-payment-method').textContent = formData.paymentMethod;
                    new QRCode(qrTrackingDiv, { text: data.trackingId, width: 128, height: 128 });

                    if (data.upiQrString) {
                        qrPaymentContainer.style.display = 'block';
                        document.getElementById('label-bill-amount').textContent = formData.billAmount;
                        new QRCode(qrPaymentDiv, { text: data.upiQrString, width: 128, height: 128 });
                    }

                    labelDiv.style.display = 'block';
                    document.getElementById('action-buttons').style.display = 'block';
                    setupActionButtons(data.trackingId, data.otp, formData.phone);
                    loadAllDeliveries();
                    bookingForm.reset();

                } else {
                    resultDiv.className = 'error';
                    resultDiv.innerHTML = `<strong>‡§ó‡•ú‡§¨‡•ú‡•Ä:</strong> ${data.message}`;
                }

            } catch (error) {
                resultDiv.className = 'error';
                resultDiv.innerHTML = `<strong>‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ ‡§∞‡§π‡§æ ‡§π‡•à‡•§</strong>`;
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = "‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç";
        });
        
        // --- 6. ‡§®‡§Ø‡§æ ‡§°‡§ø‡§≤‡•Ä‡§µ‡§∞‡•Ä ‡§¨‡•â‡§Ø ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï ---
        document.getElementById('create-boy-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const resultDiv = document.getElementById('create-boy-result');
            const formData = {
                name: document.getElementById('boy-name').value,
                email: document.getElementById('boy-email').value,
                password: document.getElementById('boy-password').value
            };
            
            resultDiv.textContent = 'Creating...';
            resultDiv.className = '';

            try {
                const response = await fetch('/admin/create-delivery-boy', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(formData)
                });
                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'success';
                    resultDiv.textContent = data.message;
                    form.reset();
                    loadDeliveryBoys(); // ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§∞‡•Ä‡§´‡•ç‡§∞‡•á‡§∂ ‡§ï‡§∞‡•á‡§Ç
                } else {
                    resultDiv.className = 'error';
                    resultDiv.textContent = `Error: ${data.message}`;
                }
            } catch (err) {
                resultDiv.className = 'error';
                resultDiv.textContent = 'Server error.';
            }
        });

        // --- 7. ‡§è‡§ï‡•ç‡§∂‡§® ‡§¨‡§ü‡§® (Print/Share) ---
        function setupActionButtons(trackingId, otp, phone) {
            document.getElementById('share-btn').onclick = () => {
                const shareText = `Thanks for choosing Sahyog Medical!\nYour Tracking ID: ${trackingId}\nYour OTP for delivery: ${otp}\nTrack here: ${window.location.origin}/track`;
                if (navigator.share) {
                    navigator.share({ title: 'Your Order is Booked!', text: shareText });
                } else {
                    navigator.clipboard.writeText(shareText);
                    alert('Tracking details copied to clipboard!');
                }
            };
            
            document.getElementById('print-btn').onclick = () => {
                const labelContent = document.getElementById('label').innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>Print Label</title><style>
                    body{font-family:Arial,sans-serif;} 
                    #qr-container { display: flex; justify-content: space-around; }
                    #qrcode-tracking img, #qrcode-payment img { width: 128px; height: 128px; }
                    @media print { body { -webkit-print-color-adjust: exact; } }
                </style></head><body>`);
                printWindow.document.write(labelContent);
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.print();
            };
        }

        // --- 8. Helper Functions ---
        function toggleBillAmount(value) {
            document.getElementById('billAmountDiv').style.display = (value === 'COD') ? 'block' : 'none';
        }
        
        document.getElementById('logout-btn').onclick = () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole'); // ‡§∞‡•ã‡§≤ (Role) ‡§ï‡•ã ‡§≠‡•Ä ‡§π‡§ü‡§æ‡§è‡§Å
            window.location.href = '/login';
        };
    </script>
</body>
</html>