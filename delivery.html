<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Panel</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button { padding: 10px 15px; margin: 5px 0; }
        input { padding: 10px; width: 200px; }
        #reader { width: 300px; border: 1px solid #ccc; }
        #pending-list li { background: #f9f9f9; padding: 10px; margin-bottom: 5px; list-style: none; }
        .message { padding: 10px; margin-top: 10px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Delivery Panel (Welcome, <span id="delivery-name"></span>)</h1>
        <button id="logout-btn">Logout</button>
    </div>
    <button id="enable-notifications" style="background-color: #28a745;">Enable Notifications</button>

    <h2>1. My Assigned Deliveries</h2>
    <button id="fetch-pending">Refresh My Deliveries</button>
    <ul id="pending-list"></ul>
    
    <h2>2. Scan QR to Start (Out for Delivery)</h2>
    <div id="reader"></div>
    <div id="scan-result" class="message" style="display:none;"></div>

    <h2>3. Complete Delivery (Delivered)</h2>
    <input type="text" id="otp-tracking-id" placeholder="Tracking ID..."><br>
    <input type="text" id="otp-code" placeholder="Customer OTP..."><br>
    <button id="complete-btn">Delivery Complete करें</button>
    <div id="otp-result" class="message" style="display:none;"></div>

    <script>
    const token = localStorage.getItem('authToken');
    const role = localStorage.getItem('userRole'); // नया: रोल (Role) को पढ़ना
    
    const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };
    // ... (बाकी के variable definitions) ...

    // --- 1. (सबसे ज़रूरी) सिक्योरिटी गार्ड ---
    window.onload = () => {
        // अगर टोकन नहीं है या रोल 'delivery' नहीं है, तो बाहर निकालो
        if (!token || role !== 'delivery') {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole');
            window.location.href = '/login'; // लॉगिन पेज पर वापस भेजें
            return; // बाकी का कोड मत चलाओ
        }

        // अगर डिलीवरी बॉय है, तो ही पेज लोड करो
        document.getElementById('delivery-name').textContent = localStorage.getItem('userName');
        loadAssignedDeliveries();
        startScanner(); // स्कैनर शुरू करें
    };

    // ... (बाकी का सारा JavaScript कोड जैसा था वैसा ही रहेगा) ...

    // --- 6. Logout --- (इसे भी अपडेट करें)
    document.getElementById('logout-btn').onclick = () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userName');
        localStorage.removeItem('userRole'); // रोल (Role) को भी हटाएँ
        window.location.href = '/login';
    };
</script>
</body>
</html>