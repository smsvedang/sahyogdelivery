<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Sahyog Medical</title>
    <style>
        /* Basic Styles (similar to admin) */
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        h1, h2 { color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 20px;}
        .header button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button { cursor: pointer; border-radius: 5px; padding: 10px 15px; border: none; margin: 2px; }
        button.btn-primary { background-color: #007bff; color: white; }
        button.btn-secondary { background-color: #6c757d; color: white; }
        .tab-bar { border-bottom: 2px solid #dee2e6; margin-bottom: 20px; }
        .tab-bar button { background: #e9ecef; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0; margin-bottom: -2px; border: 1px solid #dee2e6; border-bottom: none; }
        .tab-bar button.active { background: #ffffff; border-bottom: 2px solid #ffffff; font-weight: bold; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #dee2e6; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #e9ecef; }
        form label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        form input, form select { width: 95%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        .footer { text-align: center; margin-top: 30px; color: #888; font-size: 0.9em; }
        .message { padding: 10px; margin-top: 10px; border-radius: 5px; }
        .success { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .error { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Manager Dashboard (Welcome, <span id="manager-name"></span>)</h1>
        <button id="logout-btn" class="btn-danger">Logout</button>
    </div>

    <div class="tab-bar">
        <button class="tab-link active" onclick="openTab(event, 'tab-pickups')">Pending Pickups</button>
        <button class="tab-link" onclick="openTab(event, 'tab-boys')">Manage Delivery Boys</button>
    </div>

    <div id="tab-pickups" class="tab-content active">
        <div class="card" style="min-width: 95%; overflow-x: auto;">
            <h2>Pending Pickups (Ready to Assign)</h2>
            <button id="refresh-pickups-btn" class="btn-secondary">Refresh List</button>
            <table id="pickups-table">
                <thead>
                    <tr>
                        <th>Tracking ID</th>
                        <th>Customer</th>
                        <th>Address</th>
                        <th>Payment</th>
                        <th>Date Booked</th>
                        <th>Assign To</th>
                    </tr>
                </thead>
                <tbody id="pickups-body"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-boys" class="tab-content">
        <div class="card" id="manage-boys-area">
            <h2>Manage My Delivery Boys</h2>
            <form id="create-boy-form" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                 <h3>Add New Delivery Boy</h3>
                <label for="boy-name">Name:</label>
                <input type="text" id="boy-name" required>
                <label for="boy-email">Email (Username):</label>
                <input type="email" id="boy-email" required>
                 <label for="boy-phone">Phone:</label>
                <input type="text" id="boy-phone">
                <label for="boy-password">Password:</label>
                <input type="text" id="boy-password" required>
                <button type="submit" class="btn-primary">Create Delivery Boy</button>
                <div id="create-boy-result" class="message"></div>
            </form>

            <h3>My Delivery Boys List</h3>
             <button id="refresh-boys-btn" class="btn-secondary">Refresh List</button>
            <table id="boys-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="boys-body"></tbody>
            </table>
        </div>
    </div>

     <div class="footer">
        Copyright © <span id="copyright-year"></span> Sahyog Medical. All Rights Reserved.
    </div>


    <script>
        const token = localStorage.getItem('authToken');
        const role = localStorage.getItem('userRole');
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        let myDeliveryBoys = []; // Store boys for assignment dropdown

        // --- 1. Security Guard & Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!token || role !== 'manager') {
                localStorage.clear();
                window.location.href = '/login';
                return;
            }
            const managerNameEl = document.getElementById('manager-name');
            const copyrightYearEl = document.getElementById('copyright-year');
            if(managerNameEl) managerNameEl.textContent = localStorage.getItem('userName');
            if(copyrightYearEl) copyrightYearEl.textContent = new Date().getFullYear();

            // Setup static listeners
            const refreshPickupsBtn = document.getElementById('refresh-pickups-btn');
            const createBoyForm = document.getElementById('create-boy-form');
            const refreshBoysBtn = document.getElementById('refresh-boys-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if(refreshPickupsBtn) refreshPickupsBtn.onclick = loadPendingPickups;
            if(createBoyForm) createBoyForm.addEventListener('submit', handleCreateBoySubmit);
             if(refreshBoysBtn) refreshBoysBtn.onclick = loadMyBoys;
            if(logoutBtn) logoutBtn.onclick = () => { localStorage.clear(); window.location.href = '/login'; };

            // Initial loads
            loadPendingPickups();
            loadMyBoys(); // Load boys initially for dropdowns
        });

        // --- 2. Tab Logic ---
        function openTab(event, tabName) {
            // ... (same tab logic as admin.html) ...
            if (tabName === 'tab-pickups') loadPendingPickups();
            if (tabName === 'tab-boys') loadMyBoys();
        }

        // --- 3. Load Pending Pickups ---
        async function loadPendingPickups() {
            const tbody = document.getElementById('pickups-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6">Loading pending pickups...</td></tr>';
            try {
                const response = await fetch('/manager/pending-pickups', { headers });
                if (response.status === 401) { window.location.href = '/login'; return; }
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const deliveries = await response.json();
                tbody.innerHTML = '';
                if(deliveries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No pending pickups found.</td></tr>'; return;
                }
                deliveries.forEach(d => {
                    const row = document.createElement('tr');
                    const date = new Date(d.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
                    // Create dropdown for assignment
                    let assignDropdown = `<select id="assign-${d._id}" onchange="assignDelivery('${d._id}', this.value)">`;
                    assignDropdown += `<option value="">Assign to...</option>`;
                    myDeliveryBoys.forEach(boy => {
                        if (boy.isActive) { // Only show active boys
                             assignDropdown += `<option value="${boy._id}">${boy.name}</option>`;
                        }
                    });
                    assignDropdown += `</select>`;

                    row.innerHTML = `
                        <td>${d.trackingId}</td>
                        <td>${d.customerName || 'N/A'}</td>
                        <td>${d.customerAddress || 'N/A'}</td>
                        <td>${d.paymentMethod === 'COD' ? `₹${d.billAmount}` : 'Prepaid'}</td>
                        <td>${date}</td>
                        <td>${assignDropdown}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (err) {
                 console.error("Error loading pickups:", err);
                 tbody.innerHTML = `<tr><td colspan="6" style="color: red; text-align: center;">Error loading pickups: ${err.message}</td></tr>`;
            }
        }

         // --- 4. Load My Delivery Boys (for Manage Tab & Dropdown) ---
        async function loadMyBoys() {
            const tbody = document.getElementById('boys-body');
            if (tbody) tbody.innerHTML = '<tr><td colspan="5">Loading delivery boys...</td></tr>';
            try {
                const response = await fetch('/manager/my-boys', { headers });
                if (response.status === 401) { window.location.href = '/login'; return; }
                 if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const users = await response.json();
                myDeliveryBoys = users; // Store for dropdowns

                if (tbody) { // Update table only if in Manage tab
                    tbody.innerHTML = '';
                    if(users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No delivery boys found. Add one below.</td></tr>';
                    }
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        const statusClass = user.isActive ? 'status-active' : 'status-inactive';
                        const toggleButtonText = user.isActive ? 'Deactivate' : 'Activate';
                        // Managers generally shouldn't activate/deactivate, only admin
                        // Add edit/password reset later if needed
                        row.innerHTML = `
                            <td>${user.name}</td>
                            <td>${user.email}</td>
                            <td>${user.phone || 'N/A'}</td>
                            <td><span class="${statusClass}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                            <td> TBD </td> {/* Placeholder for future actions */}
                        `;
                        tbody.appendChild(row);
                    });
                }
                 // After loading boys, refresh the pickups tab if it's active, to update dropdowns
                 const activeTab = document.querySelector('.tab-content.active');
                 if(activeTab && activeTab.id === 'tab-pickups') {
                      loadPendingPickups();
                 }

            } catch (err) {
                 console.error("Error loading my boys:", err);
                 if (tbody) tbody.innerHTML = `<tr><td colspan="5" style="color: red; text-align: center;">Error loading boys: ${err.message}</td></tr>`;
            }
        }

        // --- 5. Handle Create Delivery Boy ---
        async function handleCreateBoySubmit(e) {
             e.preventDefault();
             const resultDiv = document.getElementById('create-boy-result');
             if(!resultDiv) return;
             resultDiv.textContent = 'Creating...';
             resultDiv.className = 'message';
             const formData = {
                 name: document.getElementById('boy-name').value,
                 email: document.getElementById('boy-email').value,
                 phone: document.getElementById('boy-phone').value,
                 password: document.getElementById('boy-password').value
             };
             try {
                 // Use the new manager-specific endpoint
                const response = await fetch('/manager/create-delivery-boy', { method: 'POST', headers, body: JSON.stringify(formData) });
                const data = await response.json();
                 if (response.ok) {
                     resultDiv.textContent = data.message;
                     resultDiv.className = 'message success';
                     e.target.reset();
                     loadMyBoys(); // Refresh list
                 } else {
                     resultDiv.textContent = `Error: ${data.message}`;
                     resultDiv.className = 'message error';
                 }
             } catch (err) {
                 console.error("Create boy error:", err);
                 resultDiv.textContent = 'Server error during creation.';
                 resultDiv.className = 'message error';
            }
        }

        // --- 6. Handle Assign Delivery ---
        async function assignDelivery(deliveryId, assignedBoyId) {
             if (!assignedBoyId) return; // Ignore if "Assign to..." is selected
             if (!confirm(`Assign this delivery to the selected boy?`)) {
                 // Reset dropdown if cancelled
                 const selectEl = document.getElementById(`assign-${deliveryId}`);
                 if(selectEl) selectEl.value = "";
                 return;
             }
             try {
                const response = await fetch(`/manager/assign-delivery/${deliveryId}`, {
                    method: 'PATCH',
                    headers: headers,
                    body: JSON.stringify({ assignedBoyId })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Delivery assigned successfully!');
                    loadPendingPickups(); // Refresh the list
                } else {
                     alert(`Error: ${data.message}`);
                      // Reset dropdown on failure
                     const selectEl = document.getElementById(`assign-${deliveryId}`);
                     if(selectEl) selectEl.value = "";
                }
             } catch (err) {
                  console.error("Assign delivery error:", err);
                  alert('Server error during assignment.');
                   // Reset dropdown on failure
                 const selectEl = document.getElementById(`assign-${deliveryId}`);
                 if(selectEl) selectEl.value = "";
             }
        }

    </script>

</body>
</html>