<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard - Sahyog Medical</title>
    <style>
        /* General Styles */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        h1, h2, h3 { color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ccc; margin-bottom: 20px;}
        .header button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button { cursor: pointer; border-radius: 5px; padding: 10px 15px; border: none; margin: 2px; }
        button.btn-primary { background-color: #007bff; color: white; }
        button.btn-secondary { background-color: #6c757d; color: white; }
        button.btn-danger { background-color: #dc3545; color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        input, select { width: calc(100% - 24px); padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; color: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #e9ecef; }
        td select { width: 100%; font-size: 14px; padding: 8px; } /* Dropdown inside table */
        .footer { text-align: center; margin-top: 30px; color: #888; font-size: 0.9em; }

        /* Tabs */
        .tab-bar { border-bottom: 2px solid #dee2e6; margin-bottom: 20px; }
        .tab-bar button { background: #e9ecef; border: none; padding: 10px 15px; cursor: pointer; font-size: 16px; border-radius: 5px 5px 0 0; margin-bottom: -2px; border: 1px solid #dee2e6; border-bottom: none; }
        .tab-bar button.active { background: #ffffff; border-bottom: 2px solid #ffffff; font-weight: bold; }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        .card { background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 25px; border: 1px solid #dee2e6; margin-bottom: 20px; }

        /* User Status Indicator */
        .status-active { color: #198754; font-weight: bold; }
        .status-inactive { color: #dc3545; font-weight: bold; }
        
        /* Message Styles */
        .message { padding: 10px; margin-top: 10px; border-radius: 5px; display: none; }
        .message.success { display: block; background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .message.error { display: block; background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Manager Dashboard (Welcome, <span id="manager-name"></span>)</h1>
        <button id="logout-btn" class="btn-danger">Logout</button>
    </div>

    <div class="tab-bar">
        <button class="tab-link active" onclick="openTab(event, 'tab-pickups')">Assign Pickups</button>
        <button class="tab-link" onclick="openTab(event, 'tab-all-pending')">All Pending Deliveries</button>
        <button class="tab-link" onclick="openTab(event, 'tab-boys')">Manage Delivery Boys</button>
    </div>

    <div id="tab-pickups" class="tab-content active">
        <div class="card" style="min-width: 95%; overflow-x: auto;">
            <h2>Pending Pickups (Ready to Assign)</h2>
            <p>Yeh woh deliveries hain jo Admin ne aapko assign ki hain, lekin aapne abhi tak kisi delivery boy ko nahi di hain.</p>
            <button id="refresh-pickups-btn" class="btn-secondary">Refresh List</button>
            <table id="pickups-table">
                <thead>
                    <tr>
                        <th>Tracking ID</th>
                        <th>Customer</th>
                        <th>Address</th>
                        <th>Payment</th>
                        <th>Date Booked</th>
                        <th>Assign To</th>
                    </tr>
                </thead>
                <tbody id="pickups-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="tab-all-pending" class="tab-content">
        <div class="card" style="min-width: 95%; overflow-x: auto;">
            <h2>All My Pending Deliveries</h2>
            <p>Yeh list aapke sabhi active orders dikhati hai (jo abhi tak 'Delivered' ya 'Cancelled' nahi hue hain).</p>
            <button id="refresh-all-pending-btn" class="btn-secondary">Refresh List</button>
            <table id="all-pending-table">
                <thead>
                    <tr>
                        <th>Tracking ID</th>
                        <th>Customer Name</th>
                        <th>Status</th>
                        <th>Assigned Boy</th>
                        <th>Payment</th>
                        <th>OTP</th>
                    </tr>
                </thead>
                <tbody id="all-pending-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="tab-boys" class="tab-content">
        <div class="card" id="manage-boys-area">
            <h2>Manage My Delivery Boys</h2>
            <form id="create-boy-form" style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee;">
                 <h3>Add New Delivery Boy</h3>
                <label for="boy-name">Name:</label>
                <input type="text" id="boy-name" required>
                <label for="boy-email">Email (Username):</label>
                <input type="email" id="boy-email" required>
                 <label for="boy-phone">Phone:</label>
                <input type="text" id="boy-phone">
                <label for="boy-password">Password:</label>
                <input type="text" id="boy-password" required>
                <button type="submit" class="btn-primary">Create Delivery Boy</button>
                <div id="create-boy-result" class="message"></div>
            </form>

            <h3>My Delivery Boys List</h3>
             <button id="refresh-boys-btn" class="btn-secondary">Refresh List</button>
            <table id="boys-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="boys-body">
                    </tbody>
            </table>
        </div>
    </div>

     <div class="footer">
        Copyright Â© <span id="copyright-year"></span> Sahyog Medical. All Rights Reserved.
    </div>


    <script>
        // --- 1. Global Variables & Constants ---
        const token = localStorage.getItem('authToken');
        const role = localStorage.getItem('userRole');
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
        let allDeliveriesData = []; // Store delivery data for reprint/bulk actions
        let allUsersData = []; // Store user data for editing
        let businessSettings = {}; // Holds loaded business settings

        // --- 2. Tab Logic (Must be defined globally for onclick) ---
        function openTab(event, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { if(tabcontent[i]) tabcontent[i].style.display = "none"; }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) { if(tablinks[i]) tablinks[i].className = tablinks[i].className.replace(" active", ""); }
            const currentTab = document.getElementById(tabName);
            if (currentTab) currentTab.style.display = "block";
            if (event && event.currentTarget) event.currentTarget.className += " active";
            
            if (tabName === 'tab-deliveries') loadAllDeliveries();
            if (tabName === 'tab-manage') loadAllUsers();
            if (tabName === 'tab-settings') loadBusinessSettings();
        }

        // --- 3. Modal Helpers ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = 'flex';
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) modal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target.id);
            }
        }

        // --- 4. Helper Functions ---
        function toggleBillAmount(value) {
            const div = document.getElementById('billAmountDiv');
            if(div) div.style.display = (value === 'COD') ? 'block' : 'none';
        }

        // --- 5. Label Generation & Print ---
        function generateSingleLabelHtml(name, address, trackingId, paymentMethod, phone, qrPlaceholderId) {
            const logoHtml = businessSettings.logoUrl
                ? `<img src="${businessSettings.logoUrl}" alt="${businessSettings.businessName || 'Logo'}" style="max-height: 40px; max-width: 120px; margin-bottom: 5px;">`
                : `<strong>${businessSettings.businessName || 'Sahyog Medical'}</strong>`;

            return `
                <div class="label-grid-container" style="border: 1.5px solid black; display: grid; grid-template-columns: 60% 40%; grid-template-rows: auto auto auto 1fr; width: 100mm; min-height: 140mm; height: auto; font-family: Arial, sans-serif; font-size: 10pt; background: white; margin-bottom: 5mm; page-break-inside: avoid;">
                    <style scoped>
                        *, *::before, *::after { box-sizing: border-box; }
                        .label-grid-container { border: 1.5px solid black !important; display: grid !important; grid-template-columns: 60% 40% !important; grid-template-rows: auto auto auto 1fr !important; width: 100mm !important; min-height: 140mm !important; height: auto !important; font-family: Arial, sans-serif !important; font-size: 10pt !important; background: white !important; margin: 0 !important; padding: 0 !important; page-break-inside: avoid !important; }
                        .label-grid-container div { padding: 4px 6px !important; border-bottom: 1px solid black; border-right: 1px solid black; box-sizing: border-box; word-wrap: break-word; overflow: hidden; }
                        .label-grid-container div:nth-child(2n) { border-right: none; }
                        .grid-qr-code { border-bottom: none !important; }
                        .grid-header { font-weight: bold; background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        .grid-ship-to { grid-column: 1 / 2; grid-row: 2 / 3; }
                        .grid-from { grid-column: 2 / 3; grid-row: 2 / 3; }
                        .grid-order-id { grid-column: 1 / 2; grid-row: 3 / 4; }
                        .grid-remarks { grid-column: 2 / 3; grid-row: 3 / 4; }
                        .grid-qr-code { grid-column: 1 / 3; grid-row: 4 / 5; text-align: center; padding-top: 10px !important; padding-bottom: 5px !important; border-top: 1.5px solid black; }
                        .grid-qr-code .qr-code-img img { display: block; margin: 0 auto 5px auto; width: 90px !important; height: 90px !important; }
                        .grid-qr-code small { font-size: 8pt; font-weight: bold; letter-spacing: 1px; display: block; }
                        .label-grid-container p { margin: 1px 0; padding: 0; font-size: 9pt; }
                    </style>
                    <div class="grid-header">SHIP TO:</div> <div class="grid-header">FROM:</div>
                    <div class="grid-ship-to"><p><strong>${name||'N/A'}</strong></p><p>${address||'N/A'}</p><p>Ph: ${phone||'N/A'}</p></div>
                    <div class="grid-from">${logoHtml}<p>${businessSettings.businessAddress||'N/A'}</p><p>Ph: ${businessSettings.businessPhone||'N/A'}</p></div>
                    <div class="grid-order-id">ORDER ID: <strong>${trackingId||'N/A'}</strong></div>
                    <div class="grid-remarks">REMARKS: <strong>${paymentMethod||'Prepaid'}</strong></div>
                    <div class="grid-qr-code"><div id="${qrPlaceholderId}" class="qr-code-img"></div><small>TRACK${trackingId||'N/A'}</small></div>
                </div>
            `;
        }

        function generateLabelPreview(name, address, trackingId, paymentMethod, phone) {
            const labelDiv = document.getElementById('label');
            if (!labelDiv) { console.error("#label preview div not found!"); return false; }
            const qrPlaceholderId = 'qrcode-tracking-preview';
            labelDiv.innerHTML = generateSingleLabelHtml(name, address, trackingId, paymentMethod, phone, qrPlaceholderId);
            labelDiv.style.display = 'block';
            const qrElement = labelDiv.querySelector(`#${qrPlaceholderId}`);
            if (qrElement && trackingId) {
                qrElement.innerHTML = '';
                try { new QRCode(qrElement, { text: trackingId, width: 100, height: 100, correctLevel: QRCode.CorrectLevel.H }); return true; }
                catch (qrError) { console.error("QR Error:", qrError); qrElement.innerHTML = '<p style="color:red; font-size: small;">QR Error</p>'; }
            } else { console.error("QR Placeholder/TrackingID missing for preview."); }
            return false;
        }

        function setupActionButtons(trackingId, otp, phone) {
            console.log("Setting up action buttons for:", trackingId);
            const shareBtn = document.getElementById('share-btn');
            const printBtn = document.getElementById('print-btn');
            if (shareBtn) {
                shareBtn.onclick = null; // Remove previous
                shareBtn.onclick = async () => {
                    console.log("Share button clicked!");
                    const shareText = `Thanks for choosing Sahyog Medical!\nYour Tracking ID: ${trackingId}\nYour OTP for delivery: ${otp}\nTrack here: ${window.location.origin}/track`;
                    if (navigator.share) {
                        try { await navigator.share({ title: 'Your Order is Booked!', text: shareText }); console.log('Shared OK'); }
                        catch (err) {
                            console.error("Share failed:", err);
                            if (navigator.clipboard) { try { await navigator.clipboard.writeText(shareText); alert('Details copied!'); } catch (clipErr) { console.error("Clipboard failed:", clipErr); alert('Copy failed.'); console.log(shareText); } }
                            else { alert('Share/Copy failed.'); console.log(shareText); }
                        }
                    } else if (navigator.clipboard) { try { await navigator.clipboard.writeText(shareText); alert('Details copied!'); } catch (clipErr) { console.error("Clipboard failed:", clipErr); alert('Copy failed.'); console.log(shareText); } }
                    else { alert('Share/Copy failed.'); console.log(shareText); }
                };
            } else { console.error("#share-btn missing!"); }
            if (printBtn) {
                 printBtn.onclick = () => {
                     const deliveryData = allDeliveriesData.find(d => d.trackingId === trackingId);
                     if (!deliveryData) {
                         console.warn("Using passed data for print.");
                         const currentFormData = { name: document.getElementById('name').value, address: document.getElementById('address').value, paymentMethod: document.getElementById('paymentMethod').value };
                         printSingleLabel(currentFormData.name, currentFormData.address, trackingId, currentFormData.paymentMethod, phone); return;
                     }
                     printSingleLabel(deliveryData.customerName, deliveryData.customerAddress, deliveryData.trackingId, deliveryData.paymentMethod, deliveryData.customerPhone);
                 };
            } else { console.error("#print-btn missing!"); }
        }

        function printSingleLabel(name, address, trackingId, paymentMethod, phone) {
            const qrPlaceholderId = `print-qr-${trackingId}-${Date.now()}`;
            const labelHtml = generateSingleLabelHtml(name, address, trackingId, paymentMethod, phone, qrPlaceholderId);
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) { alert("Please allow popups to print."); return; }
            printWindow.document.write(`<html><head><title>Print Label - ${trackingId}</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script><style>body{margin:0;padding:0}@page{size:A4 portrait;margin:5mm}.label-grid-container{border:1.5px solid black !important;margin:0 !important;width:190mm !important;height:270mm !important;box-sizing:border-box;page-break-inside:avoid}@media print{-webkit-print-color-adjust:exact;print-color-adjust:exact}</style></head><body>${labelHtml}<script>try{const el=document.getElementById('${qrPlaceholderId}');if(el&&'${trackingId}'){new QRCode(el,{text:'${trackingId}',width:100,height:100,correctLevel:QRCode.CorrectLevel.H})}else{console.error("QR Element/ID missing")}}catch(e){console.error("QR Error:",e);const el=document.getElementById('${qrPlaceholderId}');if(el)el.innerHTML='QR Error'}setTimeout(()=>{window.print()},500);<\/script></body></html>`);
            printWindow.document.close();
        }

        function printLabelInternal() {
            console.log("Print label button clicked (Internal handler)");
            const label = document.getElementById('label');
            if (!label || label.style.display === 'none') {
                 alert("Generate label first.");
                 console.log("Print aborted: Label not visible or not found");
                 return;
            }
            window.print();
        }

        // --- 11. Business Settings Logic ---
        async function loadBusinessSettings() {
            const resDiv=document.getElementById('settings-result'),logoPre=document.getElementById('logo-preview'); if(!resDiv||!logoPre)return;
            resDiv.textContent='Loading...';resDiv.className='message';
            try{const r=await fetch('/admin/settings',{headers});if(r.status===401){window.location.href='/login';return}if(!r.ok)throw new Error(`HTTP ${r.status}`); const s=await r.json(); businessSettings=s;
            const nameEl=document.getElementById('business-name'),addrEl=document.getElementById('business-address'),phoneEl=document.getElementById('business-phone'),logoUrlEl=document.getElementById('business-logo-url'),upiIdEl=document.getElementById('upi-id'),upiNameEl=document.getElementById('upi-name');
            if(nameEl)nameEl.value=s.businessName||''; if(addrEl)addrEl.value=s.businessAddress||''; if(phoneEl)phoneEl.value=s.businessPhone||''; if(logoUrlEl)logoUrlEl.value=s.logoUrl||''; if(upiIdEl)upiIdEl.value=s.upiId||''; if(upiNameEl)upiNameEl.value=s.upiName||'';
            if(s.logoUrl){logoPre.src=s.logoUrl;logoPre.style.display='block'}else{logoPre.style.display='none'} resDiv.textContent='';
            }catch(e){console.error("Load settings error:",e);resDiv.textContent=`Error: ${e.message}`;resDiv.className='message error'}
        }
        async function loadBusinessSettingsOnLoad() {
             try {
                const response = await fetch('/admin/settings', { headers });
                if (response.ok) { businessSettings = await response.json(); console.log("Initial settings loaded:", businessSettings); }
                else { console.error("Failed initial settings load"); }
            } catch (err) { console.error("Initial settings load error:", err); }
        }
        async function handleBusinessSettingsSubmit(e) {
            e.preventDefault(); const btn=e.target.querySelector('button[type="submit"]'),resDiv=document.getElementById('settings-result'),logoPre=document.getElementById('logo-preview'); if(!btn||!resDiv||!logoPre)return;
            btn.disabled=true;btn.textContent='Saving...';resDiv.textContent='';resDiv.className='message';
            const data={businessName:e.target.elements['business-name'].value,businessAddress:e.target.elements['business-address'].value,businessPhone:e.target.elements['business-phone'].value,logoUrl:e.target.elements['business-logo-url'].value,upiId:e.target.elements['upi-id'].value,upiName:e.target.elements['upi-name'].value};
            try{const r=await fetch('/admin/settings',{method:'PUT',headers,body:JSON.stringify(data)}); const d=await r.json();
            if(r.ok){resDiv.textContent=d.message||'Saved!';resDiv.className='message success';businessSettings=d.settings||data; if(businessSettings.logoUrl){logoPre.src=businessSettings.logoUrl;logoPre.style.display='block'}else{logoPre.style.display='none'}}
            else{resDiv.textContent=`Error: ${d.message||'Save failed.'}`;resDiv.className='message error'}
            }catch(e){console.error("Save settings error:",e);resDiv.textContent=`Server error: ${e.message}`;resDiv.className='message error'}
            finally{btn.disabled=false;btn.textContent='Save Settings';setTimeout(()=>{if(resDiv)resDiv.textContent=''},3000)}
        }

        // --- 4. Load All Deliveries (Definition) ---
        async function loadAllDeliveries() {
            const tbody = document.getElementById('all-deliveries-body');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectionCount();
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="10">Loading deliveries...</td></tr>'; // *** FIX: Colspan 10 (OTP hata diya) ***
            try {
                const response = await fetch('/admin/deliveries', { headers });
                if (response.status === 401) { window.location.href = '/login'; return; }
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                const deliveries = await response.json();
                allDeliveriesData = deliveries;
                tbody.innerHTML = '';
                if(deliveries.length === 0) { tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">No deliveries found.</td></tr>'; return; } // *** FIX: Colspan 10 ***
                
                deliveries.forEach(d => {
                    const row = tbody.insertRow(); row.style.verticalAlign = 'middle';
                    const cellCheckbox = row.insertCell(0); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'delivery-checkbox'; checkbox.value = d._id; cellCheckbox.appendChild(checkbox); cellCheckbox.style.width = '30px';
                    row.insertCell(1).textContent = d.trackingId || 'N/A';
                    row.insertCell(2).textContent = d.customerName || 'N/A';
                    const cellStatus = row.insertCell(3); cellStatus.innerHTML = `<strong>${d.currentStatus || 'N/A'}</strong>`;
                    
                    // *** FIX: Payment column ab sirf Mode dikhayega ***
                    row.insertCell(4).textContent = d.paymentMethod || 'N/A';
                    
                    let codStatusText = 'N/A'; if (d.paymentMethod === 'COD') { codStatusText = d.codPaymentStatus || 'Pending'; } row.insertCell(5).textContent = codStatusText;
                    row.insertCell(6).textContent = d.assignedByManager && d.assignedByManager.name ? d.assignedByManager.name : 'N/A';
                    row.insertCell(7).textContent = d.assignedTo && d.assignedTo.name ? d.assignedTo.name : (d.assignedBoyDetails && d.assignedBoyDetails.name ? d.assignedBoyDetails.name + ' (Assigned)' : 'N/A');
                    
                    // *** FIX: OTP cell (index 8) hata diya gaya ***
                    
                    const date = new Date(d.createdAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric'});
                    row.insertCell(8).textContent = date; // (Yeh ab index 8 hai)
                    
                    const cellActions = row.insertCell(9); // (Yeh ab index 9 hai)
                    const isCancelable = !['Delivered', 'Cancelled'].includes(d.currentStatus);
                    cellActions.innerHTML = `<button class="btn-secondary btn-sm" onclick="reprintLabel('${d._id}')" title="Reprint Label">Reprint</button><button class="btn-warning btn-sm" onclick="cancelDelivery('${d._id}')" ${!isCancelable ? 'disabled title="Cannot cancel"' : 'title="Cancel Delivery"'}>Cancel</button><button class="btn-danger btn-sm" onclick="deleteDelivery('${d._id}')" title="Delete Record">Delete</button>`;
                });
            } catch (err) { console.error("Error loading deliveries:", err); tbody.innerHTML = `<tr><td colspan="10" style="color: red; text-align: center;">Error: ${err.message}</td></tr>`; } // *** FIX: Colspan 10 ***
        }

        // --- 5. Booking Form Submit Handler (Definition) ---
        async function handleBookingSubmit(e) {
             e.preventDefault();
             const submitBtn = document.getElementById('submit-btn'); const resultDiv = document.getElementById('result'); const labelDiv = document.getElementById('label'); const actionButtonsDiv = document.getElementById('action-buttons');
             if(!submitBtn || !resultDiv || !labelDiv || !actionButtonsDiv) return;
             submitBtn.disabled = true; submitBtn.textContent = "Booking..."; resultDiv.innerHTML = '<p>Processing...</p>'; resultDiv.className = 'message'; labelDiv.style.display = 'none'; labelDiv.innerHTML = ''; actionButtonsDiv.style.display = 'none'; console.log("UI Reset.");
             const formData = { name: document.getElementById('name').value, address: document.getElementById('address').value, phone: document.getElementById('phone').value, paymentMethod: document.getElementById('paymentMethod').value, billAmount: document.getElementById('billAmount').value || 0, managerId: document.getElementById('assignedTo').value || null }; console.log("Submitting:", formData);
             try { console.log("POST /book..."); const response = await fetch('/book', { method: 'POST', headers, body: JSON.stringify(formData) }); console.log("Resp:", response.status, response.statusText);
                 let data; try { const txt = await response.text(); console.log("Raw:", txt); data = JSON.parse(txt); console.log("JSON:", data); } catch (e) { console.error("JSON Err:", e); if (response.ok) throw new Error("OK but invalid JSON."); data = { message: `Err ${response.status}. Invalid JSON.` }; }
                 if (response.ok) { console.log("Booking OK."); resultDiv.className = 'success'; resultDiv.innerHTML = `<strong>${data.message||'Success!'}</strong><br>ID: ${data.trackingId} | OTP: ${data.otp}`; console.log("Gen label...");
                     const labelGenerated = generateLabelPreview(formData.name, formData.address, data.trackingId, formData.paymentMethod, formData.phone);
                     if (labelGenerated) { console.log("Label OK. Buttons..."); actionButtonsDiv.style.display = 'block'; setupActionButtons(data.trackingId, data.otp, formData.phone); } else { console.error("Label FAILED!"); resultDiv.innerHTML += '<br><span style="color:orange;">Warn: Label failed.</span>'; }
                     loadAllDeliveries(); e.target.reset(); toggleBillAmount('Prepaid');
                 } else { console.error("Server FAIL:", response.status, data.message); resultDiv.className = 'error'; resultDiv.innerHTML = `<strong>Failed:</strong> ${data.message || `Error ${response.status}`}`; }
             } catch (error) { console.error("Booking catch Err:", error); resultDiv.className = 'error'; resultDiv.innerHTML = `<strong>Error:</strong> ${error.message || 'Connection failed.'}`; }
             finally { submitBtn.disabled = false; submitBtn.textContent = "Book Courier"; console.log("Booking finally."); }
        }

        // --- 6. Manage Users Logic (Definitions) ---
        async function loadAllUsers() {
            const tbody = document.getElementById('users-body'); if (!tbody) return; tbody.innerHTML = '<tr><td colspan="6">Loading users...</td></tr>';
            try { const r = await fetch('/admin/users',{headers}); if(r.status===401){window.location.href='/login';return} if(!r.ok)throw new Error(`HTTP ${r.status}`); const users = await r.json(); allUsersData = users; tbody.innerHTML=''; if(users.length===0){tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">No users.</td></tr>';return}
                users.forEach(u=>{const row=tbody.insertRow(),sClass=u.isActive?'status-active':'status-inactive',btnTxt=u.isActive?'Deactivate':'Activate',btnClass=u.isActive?'btn-warning':'btn-success'; row.insertCell().textContent=u.name; row.insertCell().textContent=u.email; row.insertCell().textContent=u.phone||'N/A'; row.insertCell().textContent=u.role; row.insertCell().innerHTML=`<span class="${sClass}">${u.isActive?'Active':'Inactive'}</span>`; row.insertCell().innerHTML=`<button class="btn-secondary btn-sm" onclick="openEditUserModal('${u._id}')">Edit</button><button class="${btnClass} btn-sm" onclick="toggleUserActive('${u._id}')">${btnTxt}</button>`; });
            } catch (e) { console.error("Load users error:", e); tbody.innerHTML=`<tr><td colspan="6" style="color:red;text-align:center;">Error: ${e.message}</td></tr>`; }
        }
        async function handleAddUserSubmit(e) {
            e.preventDefault(); const resDiv = document.getElementById('add-user-result'); if(!resDiv)return; resDiv.textContent='Creating...';resDiv.className='message'; const formData={name:e.target.elements['add-user-name'].value,email:e.target.elements['add-user-email'].value,phone:e.target.elements['add-user-phone'].value,password:e.target.elements['add-user-password'].value,role:e.target.elements['add-user-role'].value};
            try{const r=await fetch('/admin/create-user',{method:'POST',headers,body:JSON.stringify(formData)}); const d=await r.json(); if(r.ok){resDiv.textContent=d.message;resDiv.className='message success';e.target.reset();loadAllUsers();if(formData.role==='manager')loadManagersForDropdown();setTimeout(()=>closeModal('add-user-modal'),1500)} else{resDiv.textContent=`Error: ${d.message}`;resDiv.className='message error'} }catch(e){console.error("Add user error:",e);resDiv.textContent='Server error.';resDiv.className='message error'}
        }
        function openEditUserModal(userId) {
            const user = allUsersData.find(u=>u._id===userId); if(!user)return; const idEl=document.getElementById('edit-user-id'),nameEl=document.getElementById('edit-user-name'),emailEl=document.getElementById('edit-user-email'),phoneEl=document.getElementById('edit-user-phone'),roleEl=document.getElementById('edit-user-role'),passEl=document.getElementById('edit-user-password'),resEl=document.getElementById('edit-user-result');
            if(idEl)idEl.value=user._id; if(nameEl)nameEl.value=user.name; if(emailEl)emailEl.value=user.email; if(phoneEl)phoneEl.value=user.phone||''; if(roleEl)roleEl.value=user.role; if(passEl)passEl.value=''; if(resEl)resEl.textContent=''; openModal('user-edit-modal');
        }
        async function handleEditUserSubmit(e) {
            e.preventDefault(); const userId=document.getElementById('edit-user-id').value,resDiv=document.getElementById('edit-user-result'); if(!userId||!resDiv)return; resDiv.textContent='Saving...';resDiv.className='message'; const uData={name:e.target.elements['edit-user-name'].value,email:e.target.elements['edit-user-email'].value,phone:e.target.elements['edit-user-phone'].value,role:e.target.elements['edit-user-role'].value}; const newPass=e.target.elements['edit-user-password'].value;
            try{const rDet=await fetch(`/admin/user/${userId}`,{method:'PUT',headers,body:JSON.stringify(uData)}); if(!rDet.ok){const d=await rDet.json();throw new Error(d.message||'Update failed')} if(newPass&&newPass.trim()!==''){const rPass=await fetch(`/admin/user/${userId}/password`,{method:'PATCH',headers,body:JSON.stringify({password:newPass})}); if(!rPass.ok){const d=await rPass.json();throw new Error(d.message||'Pass update failed')}} resDiv.textContent='Updated!';resDiv.className='message success'; loadAllUsers();loadManagersForDropdown(); setTimeout(()=>closeModal('user-edit-modal'),1500);
            }catch(e){console.error("Edit user error:",e);resDiv.textContent=`Error: ${e.message}`;resDiv.className='message error'}
        }
        async function toggleUserActive(userId) {
             try{const r=await fetch(`/admin/user/${userId}/toggle-active`,{method:'PATCH',headers}); if(!r.ok){const d=await r.json();throw new Error(d.message||'Toggle failed')} const d=await r.json();console.log(d.message);loadAllUsers();loadManagersForDropdown();}
             catch(e){console.error("Toggle active error:",e);alert(`Error: ${e.message}`)}
        }

        // --- 7. Delivery Actions (Definitions) ---
        function reprintLabel(deliveryId) {
            const delivery = allDeliveriesData.find(d => d._id === deliveryId); if (!delivery) { alert('Delivery data not found.'); return; }
            printSingleLabel(delivery.customerName, delivery.customerAddress, delivery.trackingId, delivery.paymentMethod, delivery.customerPhone);
        }
        async function cancelDelivery(deliveryId) {
            if(!confirm('Cancel this delivery?'))return; try{const r=await fetch(`/admin/delivery/${deliveryId}/cancel`,{method:'PATCH',headers}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Cancel failed'); alert(d.message);loadAllDeliveries();}catch(e){console.error("Cancel err:",e);alert(`Error: ${e.message}`)}
        }
        async function deleteDelivery(deliveryId) {
             if(!confirm('DELETE record permanently?'))return; try{const r=await fetch(`/admin/delivery/${deliveryId}`,{method:'DELETE',headers}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Delete failed'); alert(d.message);loadAllDeliveries();}catch(e){console.error("Delete err:",e);alert(`Error: ${e.message}`)}
        }

        // --- 12. Bulk Action Helper Functions --- (Definitions)
        function getSelectedDeliveryIds(){const ids=[];document.querySelectorAll('#all-deliveries-body .delivery-checkbox:checked').forEach(cb=>ids.push(cb.value));return ids}
        function updateSelectionCount(){const count=document.querySelectorAll('#all-deliveries-body .delivery-checkbox:checked').length; const countSpan=document.getElementById('selection-count'); const selAll=document.getElementById('select-all-checkbox'); const allCb=document.querySelectorAll('#all-deliveries-body .delivery-checkbox'); if(countSpan)countSpan.textContent=`(${count} selected)`; if(selAll&&allCb.length>0){selAll.checked=(count===allCb.length);selAll.indeterminate=(count>0&&count<allCb.length)}else if(selAll){selAll.checked=false;selAll.indeterminate=false}}
        function handleSelectAll(e){if(!e||!e.target)return; document.querySelectorAll('#all-deliveries-body .delivery-checkbox').forEach(cb=>{cb.checked=e.target.checked});updateSelectionCount()}

        // --- 13. Bulk Action Handlers --- (Definitions)
        function handleBulkReprint(){
            const ids = getSelectedDeliveryIds(); if(ids.length === 0){ alert("Select deliveries."); return; } console.log("Bulk print:", ids);
            let combinedLabelsHtml = ''; let qrCodeTasks = [];
            ids.forEach((id, index) => { const delivery = allDeliveriesData.find(d => d._id === id); if (!delivery) { console.warn(`Data missing: ${id}`); return; } const qrPlaceholderId = `bulk-qr-${id}-${Date.now()}`; const pageBreak = index > 0 ? 'page-break-before: always; margin-top: 10mm;' : 'margin-top: 0;'; combinedLabelsHtml += `<div class="label-print-instance" style="${pageBreak}">`; combinedLabelsHtml += generateSingleLabelHtml( delivery.customerName, delivery.customerAddress, delivery.trackingId, delivery.paymentMethod, delivery.customerPhone, qrPlaceholderId ); combinedLabelsHtml += `</div>`; qrCodeTasks.push({ id: qrPlaceholderId, text: delivery.trackingId }); });
            const printWindow = window.open('', '_blank', 'width=800,height=600'); if (!printWindow) { alert("Allow popups."); return; }
            printWindow.document.write(`<html><head><title>Print Labels</title><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script><style>body{margin:5mm}@media print{body{margin:0}.label-print-instance{page-break-before:always;margin:5mm !important}.label-print-instance:first-child{page-break-before:avoid;margin-top:5mm !important}.label-grid-container{border:1.5px solid black !important} -webkit-print-color-adjust:exact;print-color-adjust:exact}</style></head><body>${combinedLabelsHtml}<script>const qrTasks=${JSON.stringify(qrCodeTasks)};qrTasks.forEach(t=>{const el=document.getElementById(t.id);if(el&&t.text){try{new QRCode(el,{text:t.text,width:100,height:100,correctLevel:QRCode.CorrectLevel.H})}catch(e){console.error("QR Error:",e);if(el)el.innerHTML='QR Err'}}});setTimeout(()=>{window.print()},500);<\/script></body></html>`); printWindow.document.close();
            const selectAll = document.getElementById('select-all-checkbox'); if(selectAll)selectAll.checked=false; document.querySelectorAll('.delivery-checkbox:checked').forEach(cb=>cb.checked=false); updateSelectionCount();
        }
        async function handleBulkCancel(){
            const ids=getSelectedDeliveryIds(); if(ids.length===0){alert("Select deliveries.");return} if(!confirm(`Cancel ${ids.length} deliveries?`))return; console.log("Cancelling:", ids);
            try{const r=await fetch('/admin/deliveries/bulk-cancel',{method:'POST',headers,body:JSON.stringify({deliveryIds:ids})}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Bulk cancel failed'); alert(`Cancelled ${d.cancelledCount||0}.`); loadAllDeliveries(); const sa=document.getElementById('select-all-checkbox');if(sa)sa.checked=false;updateSelectionCount();}catch(e){console.error("Bulk cancel:",e);alert(`Error: ${e.message}`)}
        }
        async function handleBulkDelete(){
            const ids=getSelectedDeliveryIds(); if(ids.length===0){alert("Select deliveries.");return} if(!confirm(`DELETE ${ids.length} records permanently?`))return; console.log("Deleting:", ids);
             try{const r=await fetch('/admin/deliveries/bulk-delete',{method:'POST',headers,body:JSON.stringify({deliveryIds:ids})}); const d=await r.json(); if(!r.ok)throw new Error(d.message||'Bulk delete failed'); alert(`Deleted ${d.deletedCount||0}.`); loadAllDeliveries(); const sa=document.getElementById('select-all-checkbox');if(sa)sa.checked=false;updateSelectionCount();}catch(e){console.error("Bulk delete:",e);alert(`Error: ${e.message}`)}
        }

        // --- 1. Security Guard & Initial Load (Main Execution) ---
        // This is the primary execution block that runs when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            if (!token || role !== 'admin') {
                localStorage.clear(); window.location.href = '/login'; return;
            }
            const adminNameEl = document.getElementById('admin-name');
            const copyrightYearEl = document.getElementById('copyright-year');
            if(adminNameEl) adminNameEl.textContent = localStorage.getItem('userName');
            if(copyrightYearEl) copyrightYearEl.textContent = new Date().getFullYear();

            // Setup static listeners
            const refreshBtn = document.getElementById('refresh-deliveries-btn');
            const addUserBtn = document.getElementById('add-user-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const bookingFormEl = document.getElementById('booking-form');
            const addUserFormEl = document.getElementById('add-user-form');
            const editUserFormEl = document.getElementById('edit-user-form');
            const businessSettingsForm = document.getElementById('business-settings-form');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const deliveriesTableBody = document.getElementById('all-deliveries-body');
            const bulkReprintBtn = document.getElementById('bulk-reprint-btn');
            const bulkCancelBtn = document.getElementById('bulk-cancel-btn');
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');

            if(refreshBtn) refreshBtn.onclick = loadAllDeliveries;
            if(addUserBtn) addUserBtn.onclick = () => {
                const resultDiv = document.getElementById('add-user-result');
                const form = document.getElementById('add-user-form');
                if(resultDiv) resultDiv.textContent = '';
                if(form) form.reset();
                openModal('add-user-modal');
            };
            if(logoutBtn) logoutBtn.onclick = () => { localStorage.clear(); window.location.href = '/login'; };
            if(bookingFormEl) bookingFormEl.addEventListener('submit', handleBookingSubmit);
            if(addUserFormEl) addUserFormEl.addEventListener('submit', handleAddUserSubmit);
            if(editUserFormEl) editUserFormEl.addEventListener('submit', handleEditUserSubmit);
            if(businessSettingsForm) businessSettingsForm.addEventListener('submit', handleBusinessSettingsSubmit);
            if(selectAllCheckbox) selectAllCheckbox.addEventListener('change', handleSelectAll);
            if(deliveriesTableBody) deliveriesTableBody.addEventListener('change', updateSelectionCount);
            if(bulkReprintBtn) bulkReprintBtn.onclick = handleBulkReprint;
            if(bulkCancelBtn) bulkCancelBtn.onclick = handleBulkCancel;
            if(bulkDeleteBtn) bulkDeleteBtn.onclick = handleBulkDelete;

            // Initial data loads
            loadManagersForDropdown();
            loadBusinessSettingsOnLoad(); // Load settings early
            loadAllDeliveries(); // Load deliveries last
        });

    </script>
</body>
</html>